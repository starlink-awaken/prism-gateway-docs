# PRISM-Gateway è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æå·¥ä½œæµ
#
# è§¦å‘æ¡ä»¶:
#   - Pull Request åˆ° main åˆ†æ”¯
#   - Push åˆ° main åˆ†æ”¯
#   - æ¯æ—¥å®šæ—¶æ‰«æ (UTC 02:00)
#   - æ‰‹åŠ¨è§¦å‘
#
# æ‰«æç»„ä»¶:
#   1. ä¾èµ–å®‰å…¨æ‰«æ (Bun Audit + npm audit)
#   2. ä»£ç å®‰å…¨æ‰«æ (ESLint Security Plugin)
#   3. æ•æ„Ÿä¿¡æ¯æ‰«æ (gitleaks)
#   4. SAST é™æ€åˆ†æ (CodeQL)
#   5. OWASP Top 10 æ£€æŸ¥
#
# å¤±è´¥æ¡ä»¶:
#   - ä¸¥é‡/é«˜å±æ¼æ´é˜»æ–­åˆå¹¶
#   - æ•æ„Ÿä¿¡æ¯æ³„éœ²é˜»æ–­åˆå¹¶
#   - OWASP A ç±»å®‰å…¨é—®é¢˜é˜»æ–­åˆå¹¶
#
# æŠ¥å‘Šç”Ÿæˆ:
#   - å®‰å…¨æ‰«ææŠ¥å‘Š
#   - ä¾èµ–æ¼æ´æ¸…å•
#   - ä¿®å¤å»ºè®®
#
# ç»´æŠ¤è€…: PRISM-Gateway Pentester Agent
# æœ€åæ›´æ–°: 2026-02-06
# ç‰ˆæœ¬: 1.0.0

name: Security Scan

on:
  # Pull Request è§¦å‘ - åœ¨ä»£ç åˆå¹¶å‰è¿›è¡Œå®‰å…¨æ£€æŸ¥
  pull_request:
    branches: [main]
    paths:
      - 'prism-gateway/**'
      - '.github/workflows/security-scan.yml'

  # Push è§¦å‘ - ç¡®ä¿ä¸»åˆ†æ”¯å§‹ç»ˆç¬¦åˆå®‰å…¨æ ‡å‡†
  push:
    branches: [main]
    paths:
      - 'prism-gateway/**'
      - '.github/workflows/security-scan.yml'

  # å®šæ—¶è§¦å‘ - æ¯æ—¥æ‰«æï¼ŒåŠæ—¶å‘ç°æ–°å¢æ¼æ´
  schedule:
    - cron: '0 2 * * *'  # UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00)

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  BUN_VERSION: '1.0'
  WORKING_DIRECTORY: './prism-gateway'
  NODE_VERSION: '20'
  # æ¼æ´ä¸¥é‡çº§åˆ«é˜ˆå€¼ (ä»¥ä¸Šçº§åˆ«å°†é˜»æ–­åˆå¹¶)
  SEVERITY_THRESHOLD: 'high'
  # å…è®¸çš„æ¼æ´æ•°é‡ (ä»…ç”¨äºä¸­ä½å±)
  ALLOWED_VULN_COUNT: '5'

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # ============================================
  # ä»»åŠ¡ 1: ä¾èµ–å®‰å…¨æ‰«æ
  # ============================================

  dependency-scan:
    name: ä¾èµ–å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è®¾ç½® Bun è¿è¡Œæ—¶
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ç¼“å­˜ node_modules
        uses: actions/cache@v3
        with:
          path: ${{ env.WORKING_DIRECTORY }}/node_modules
          key: ${{ runner.os }}-bun-depscan-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-depscan-

      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: bun install --frozen-lockfile

      - name: è¿è¡Œ Bun Audit
        id: bun-audit
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "å¼€å§‹ Bun å®‰å…¨å®¡è®¡..."
          bun pm audit > audit-report.txt 2>&1 || true
          cat audit-report.txt

          # ä¿å­˜æŠ¥å‘Š
          mkdir -p reports
          cp audit-report.txt reports/bun-audit-report.txt

      - name: è¿è¡Œ npm audit (å¤‡ç”¨)
        id: npm-audit
        working-directory: ${{ env.WORKING_DIRECTORY }}
        continue-on-error: true
        run: |
          echo "è¿è¡Œ npm audit ä½œä¸ºäº¤å‰éªŒè¯..."
          npm audit --audit-level=moderate > npm-audit-report.txt 2>&1 || true
          cat npm-audit-report.txt
          cp npm-audit-report.txt reports/npm-audit-report.txt 2>/dev/null || true

      - name: æ£€æŸ¥é«˜å±æ¼æ´
        id: vuln-check
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "æ£€æŸ¥é«˜å±æ¼æ´..."

          # è§£æå®¡è®¡ç»“æœ
          AUDIT_RESULT=$(cat audit-report.txt)

          # ç»Ÿè®¡å„çº§åˆ«æ¼æ´æ•°é‡
          CRITICAL_COUNT=$(echo "$AUDIT_RESULT" | grep -i "critical" | wc -l || echo 0)
          HIGH_COUNT=$(echo "$AUDIT_RESULT" | grep -i "high" | wc -l || echo 0)
          MODERATE_COUNT=$(echo "$AUDIT_RESULT" | grep -i "moderate" | wc -l || echo 0)
          LOW_COUNT=$(echo "$AUDIT_RESULT" | grep -i "low" | wc -l || echo 0)

          echo "critical=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE_COUNT" >> $GITHUB_OUTPUT
          echo "low=$LOW_COUNT" >> $GITHUB_OUTPUT

          # è¾“å‡ºæ‘˜è¦
          echo "## æ¼æ´ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸¥é‡çº§åˆ« | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸¥é‡ (Critical) | $CRITICAL_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| é«˜å± (High) | $HIGH_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸­å± (Moderate) | $MODERATE_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| ä½å± (Low) | $LOW_COUNT |" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥é˜»æ–­æ¡ä»¶
          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "::error::å‘ç°ä¸¥é‡æˆ–é«˜å±æ¼æ´ï¼Œè¯·ä¿®å¤åå†åˆå¹¶"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ å®‰å…¨æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "å‘ç°ä¸¥é‡æˆ–é«˜å±æ¼æ´ï¼Œå¿…é¡»ä¿®å¤åæ‰èƒ½åˆå¹¶ä»£ç ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # æ£€æŸ¥ä¸­ä½å±æ¼æ´æ•°é‡
          TOTAL_MID_LOW=$((MODERATE_COUNT + LOW_COUNT))
          if [ "$TOTAL_MID_LOW" -gt "${{ env.ALLOWED_VULN_COUNT }}" ]; then
            echo "::warning::ä¸­ä½å±æ¼æ´æ•°é‡ ($TOTAL_MID_LOW) è¶…è¿‡å…è®¸é˜ˆå€¼ (${{ env.ALLOWED_VULN_COUNT }})"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "ä¸­ä½å±æ¼æ´æ•°é‡è¶…è¿‡å»ºè®®é˜ˆå€¼ï¼Œå»ºè®®ä¿®å¤ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### âœ… ä¾èµ–å®‰å…¨æ‰«æé€šè¿‡" >> $GITHUB_STEP_SUMMARY

      - name: ç”Ÿæˆä¾èµ–æ¼æ´æŠ¥å‘Š
        if: always()
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          cat > reports/dependency-vulnerabilities.md << 'EOF'
          # ä¾èµ–æ¼æ´æ‰«ææŠ¥å‘Š

          **æ‰«ææ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **æ‰«æå·¥å…·:** Bun Audit + npm audit
          **åˆ†æ”¯:** ${{ github.ref_name }}

          ## æ¼æ´ç»Ÿè®¡

          | ä¸¥é‡çº§åˆ« | æ•°é‡ | çŠ¶æ€ |
          |---------|------|------|
          | ä¸¥é‡ (Critical) | ${{ steps.vuln-check.outputs.critical }} | ${{ steps.vuln-check.outputs.critical == '0' && 'âœ… é€šè¿‡' || 'âŒ é˜»æ–­' }} |
          | é«˜å± (High) | ${{ steps.vuln-check.outputs.high }} | ${{ steps.vuln-check.outputs.high == '0' && 'âœ… é€šè¿‡' || 'âŒ é˜»æ–­' }} |
          | ä¸­å± (Moderate) | ${{ steps.vuln-check.outputs.moderate }} | âš ï¸ å»ºè®® |
          | ä½å± (Low) | ${{ steps.vuln-check.outputs.low }} | â„¹ï¸ æç¤º |

          ## è¯¦ç»†æŠ¥å‘Š

          ### Bun Audit ç»“æœ
          ```
          $(cat audit-report.txt)
          ```

          ### ä¿®å¤å»ºè®®

          1. **ä¸¥é‡/é«˜å±æ¼æ´**: å¿…é¡»ç«‹å³ä¿®å¤
             - è¿è¡Œ `bun update` æ›´æ–°ä¾èµ–
             - æŸ¥çœ‹å…·ä½“æ¼æ´ä¿¡æ¯å¹¶å‡çº§åˆ°å®‰å…¨ç‰ˆæœ¬

          2. **ä¸­å±æ¼æ´**: å»ºè®®å°½å¿«ä¿®å¤
             - è¯„ä¼°æ¼æ´å½±å“èŒƒå›´
             - å®‰æ’æ›´æ–°è®¡åˆ’

          3. **ä½å±æ¼æ´**: å¯ç¨åå¤„ç†
             - å®šæœŸæ›´æ–°ä¾èµ–
             - å…³æ³¨å®‰å…¨å…¬å‘Š

          ## å‚è€ƒèµ„æº

          - [Bun Security](https://bun.sh/guides/install/package-management)
          - [npm audit](https://docs.npmjs.com/cli/commands/npm-audit)
          - [Node.js Security Advisories](https://github.com/nodejs/security-wg)
          EOF

      - name: ä¸Šä¼ æ‰«ææŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dependency-scan-report
          path: |
            ${{ env.WORKING_DIRECTORY }}/reports/
            ${{ env.WORKING_DIRECTORY }}/audit-report.txt
          retention-days: 30

  # ============================================
  # ä»»åŠ¡ 2: ä»£ç å®‰å…¨æ‰«æ
  # ============================================

  code-security-scan:
    name: ä»£ç å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è®¾ç½® Bun è¿è¡Œæ—¶
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: å®‰è£… ESLint å®‰å…¨æ’ä»¶
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          bun add -d eslint \
            eslint-plugin-security \
            eslint-plugin-no-secrets \
            @typescript-eslint/eslint-plugin \
            @typescript-eslint/parser

      - name: åˆ›å»º ESLint å®‰å…¨é…ç½®
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          cat > .eslintrc.security.json << 'EOF'
          {
            "extends": [
              "plugin:security/recommended"
            ],
            "plugins": ["security", "no-secrets"],
            "parser": "@typescript-eslint/parser",
            "parserOptions": {
              "ecmaVersion": "latest",
              "sourceType": "module"
            },
            "rules": {
              "security/detect-buffer-noassert": "error",
              "security/detect-child-process": "warn",
              "security/detect-disable-mustache-escape": "error",
              "security/detect-eval-with-expression": "error",
              "security/detect-no-csrf-before-method-override": "error",
              "security/detect-non-literal-fs-filename": "warn",
              "security/detect-non-literal-regexp": "warn",
              "security/detect-non-literal-require": "warn",
              "security/detect-object-injection": "warn",
              "security/detect-possible-timing-attacks": "warn",
              "security/detect-pseudoRandomBytes": "error",
              "no-secrets/secrets": "error"
            },
            "settings": {
              "no-secrets": {
                "additionalRegexes": [
                  {
                    "pattern": "(?i)(?:password|passwd|pwd|secret|api[_-]?key|token|private[_-]?key|auth[_-]?token)\\s*[=:]\\s*['\\\"]([a-zA-Z0-9._~!@#$%^&*(){};:?+=]{8,})['\\\"]",
                    "flags": "gi"
                  },
                  {
                    "pattern": "(?i)(?:aws[_-]?(?:access[_-]?)?key[_-]?id|secret[_-]?access[_-]?key)\\s*[=:]\\s*['\\\"]([A-Z0-9]{20})['\\\"]",
                    "flags": "gi"
                  },
                  {
                    "pattern": "\\b(A3T[A-Z0-9]|AKIA|AGPA|AIDA|AROA|AIPA|ANPA|ANVA|ASIA)[A-Z0-9]{16}\\b",
                    "flags": "g"
                  }
                ]
              }
            }
          }
          EOF

      - name: è¿è¡Œ ESLint å®‰å…¨æ‰«æ
        id: eslint-scan
        working-directory: ${{ env.WORKING_DIRECTORY }}
        continue-on-error: true
        run: |
          echo "å¼€å§‹ ESLint å®‰å…¨æ‰«æ..."
          mkdir -p reports

          # è¿è¡Œæ‰«æå¹¶ä¿å­˜ç»“æœ
          bunx eslint src/ \
            --config .eslintrc.security.json \
            --format json \
            --output-file reports/eslint-security-report.json \
            || true

          # ç”Ÿæˆå¯è¯»æŠ¥å‘Š
          bunx eslint src/ \
            --config .eslintrc.security.json \
            --format stylish \
            > reports/eslint-security-report.txt 2>&1 || true

          cat reports/eslint-security-report.txt

      - name: ç»Ÿè®¡å®‰å…¨é—®é¢˜
        id: security-stats
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ç»Ÿè®¡å®‰å…¨é—®é¢˜..."

          if [ -f reports/eslint-security-report.json ]; then
            ERROR_COUNT=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('reports/eslint-security-report.json', 'utf8'));
                console.log(data.length || 0);
              } catch {
                console.log(0);
              }
            ")
            WARNING_COUNT=$(grep -i "warning" reports/eslint-security-report.txt | wc -l || echo 0)
          else
            ERROR_COUNT=0
            WARNING_COUNT=0
          fi

          echo "errors=$ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "warnings=$WARNING_COUNT" >> $GITHUB_OUTPUT

          # è¾“å‡ºæ‘˜è¦
          echo "## ESLint å®‰å…¨æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "| é—®é¢˜ç±»å‹ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| é”™è¯¯ (Error) | $ERROR_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| è­¦å‘Š (Warning) | $WARNING_COUNT |" >> $GITHUB_STEP_SUMMARY

          # ä¸¥é‡å®‰å…¨é—®é¢˜é˜»æ–­
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "::error::å‘ç° $ERROR_COUNT ä¸ªå®‰å…¨ä»£ç é—®é¢˜ï¼Œè¯·ä¿®å¤åå†åˆå¹¶"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ ä»£ç å®‰å…¨æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "å‘ç°ä¸¥é‡å®‰å…¨ä»£ç é—®é¢˜ï¼Œå¿…é¡»ä¿®å¤åæ‰èƒ½åˆå¹¶ä»£ç ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### é—®é¢˜è¯¦æƒ…:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat reports/eslint-security-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "### âœ… ä»£ç å®‰å…¨æ‰«æé€šè¿‡" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ æ‰«ææŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: eslint-security-report
          path: |
            ${{ env.WORKING_DIRECTORY }}/reports/eslint-security-report.*
          retention-days: 30

  # ============================================
  # ä»»åŠ¡ 3: æ•æ„Ÿä¿¡æ¯æ‰«æ
  # ============================================

  secrets-scan:
    name: æ•æ„Ÿä¿¡æ¯æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºæ‰«æ

      - name: å®‰è£… gitleaks
        run: |
          wget https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-linux-amd64
          chmod +x gitleaks-linux-amd64
          sudo mv gitleaks-linux-amd64 /usr/local/bin/gitleaks

      - name: è¿è¡Œ gitleaks æ‰«æ
        id: gitleaks-scan
        run: |
          echo "å¼€å§‹æ•æ„Ÿä¿¡æ¯æ‰«æ..."
          mkdir -p reports

          gitleaks detect \
            --source . \
            --report-path reports/gitleaks-report.json \
            --report-format json \
            --verbose \
            || true

          # ç”Ÿæˆå¯è¯»æŠ¥å‘Š
          gitleaks detect \
            --source . \
            --report-path reports/gitleaks-report.txt \
            --report-format txt \
            --verbose \
            || true

      - name: ç»Ÿè®¡æ•æ„Ÿä¿¡æ¯æ³„éœ²
        id: secrets-stats
        run: |
          echo "ç»Ÿè®¡æ•æ„Ÿä¿¡æ¯æ³„éœ²..."

          if [ -f reports/gitleaks-report.json ]; then
            LEAK_COUNT=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('reports/gitleaks-report.json', 'utf8'));
                console.log(data.length || 0);
              } catch {
                console.log(0);
              }
            ")
          else
            LEAK_COUNT=0
          fi

          echo "leaks=$LEAK_COUNT" >> $GITHUB_OUTPUT

          # è¾“å‡ºæ‘˜è¦
          echo "## æ•æ„Ÿä¿¡æ¯æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æµ‹é¡¹ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æ½œåœ¨æ³„éœ² | $LEAK_COUNT |" >> $GITHUB_STEP_SUMMARY

          # æ•æ„Ÿä¿¡æ¯æ³„éœ²é˜»æ–­
          if [ "$LEAK_COUNT" -gt 0 ]; then
            echo "::error::å‘ç° $LEAK_COUNT å¤„æ½œåœ¨æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼Œè¯·æ£€æŸ¥åå†åˆå¹¶"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ æ•æ„Ÿä¿¡æ¯æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "å‘ç°æ½œåœ¨æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼Œå¿…é¡»å¤„ç†åæ‰èƒ½åˆå¹¶ä»£ç ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### æ³„éœ²è¯¦æƒ…:" >> $GITHUB_STEP_SUMMARY
            cat reports/gitleaks-report.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "### âœ… æ•æ„Ÿä¿¡æ¯æ‰«æé€šè¿‡" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ æ‰«ææŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: secrets-scan-report
          path: reports/gitleaks-report.*
          retention-days: 30

  # ============================================
  # ä»»åŠ¡ 4: OWASP Top 10 æ£€æŸ¥
  # ============================================

  owasp-check:
    name: OWASP Top 10 æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è®¾ç½® Bun è¿è¡Œæ—¶
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: bun install --frozen-lockfile

      - name: åˆ›å»º OWASP æ£€æŸ¥è„šæœ¬
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          cat > scripts/owasp-check.js << 'EOF'
          import { readFileSync, readdirSync } from 'fs';
          import { join } from 'path';

          const owaspChecks = {
            // A01:2021 - Broken Access Control
            brokenAccessControl: {
              patterns: [
                /authorization\s*=\s*["']user["']/i,
                /if\s*\(\s*req\.user\.id\s*===\s*params\.id/i,
              ],
              severity: 'high',
              category: 'A01'
            },
            // A02:2021 - Cryptographic Failures
            cryptoFailures: {
              patterns: [
                /password\s*=\s*["'][^"']+["']/i,
                /crypto\.createHash\(["']md5["']\)/i,
                /crypto\.createHash\(["']sha1["']\)/i,
              ],
              severity: 'critical',
              category: 'A02'
            },
            // A03:2021 - Injection
            injection: {
              patterns: [
                /execute\s*\(\s*["'].*?\$\{.*?\}.*?["']\s*\)/i,
                /eval\s*\(\s*["'].*?\$\{.*?\}.*?["']\s*\)/i,
                /query\s*\(\s*["'].*?\$\{.*?\}.*?["']\s*\)/i,
              ],
              severity: 'critical',
              category: 'A03'
            },
            // A04:2021 - Insecure Design
            insecureDesign: {
              patterns: [
                /cors\s*\(\s*\{\s*origin:\s*["']\*["']/i,
              ],
              severity: 'high',
              category: 'A04'
            },
            // A05:2021 - Security Misconfiguration
            misconfig: {
              patterns: [
                /debug:\s*true/i,
                /NODE_ENV\s*===\s*["']development["']/i,
              ],
              severity: 'medium',
              category: 'A05'
            },
            // A07:2021 - Identification and Authentication Failures
            authFailures: {
              patterns: [
                /jwt\.sign\s*\(\s*payload\s*\)/i,
                /bcrypt\.hash\(\s*password\s*,\s*[1-5]\s*\)/i,
              ],
              severity: 'high',
              category: 'A07'
            },
          };

          function checkFile(filePath) {
            const content = readFileSync(filePath, 'utf8');
            const findings = [];

            for (const [name, check] of Object.entries(owaspChecks)) {
              for (const pattern of check.patterns) {
                const matches = content.matchAll(new RegExp(pattern, 'gim'));
                for (const match of matches) {
                  findings.push({
                    category: check.category,
                    check: name,
                    severity: check.severity,
                    line: content.substring(0, match.index).split('\n').length,
                    pattern: pattern.source,
                  });
                }
              }
            }

            return findings;
          }

          function scanDirectory(dir) {
            const findings = [];
            const entries = readdirSync(dir, { withFileTypes: true });

            for (const entry of entries) {
              const fullPath = join(dir, entry.name);
              if (entry.isDirectory() && !entry.name.startsWith('.') && entry.name !== 'node_modules') {
                findings.push(...scanDirectory(fullPath));
              } else if (entry.isFile() && (entry.name.endsWith('.ts') || entry.name.endsWith('.js'))) {
                findings.push(...checkFile(fullPath));
              }
            }

            return findings;
          }

          const findings = scanDirectory('src');

          console.log(JSON.stringify({
            total: findings.length,
            findings: findings,
            summary: {
              critical: findings.filter(f => f.severity === 'critical').length,
              high: findings.filter(f => f.severity === 'high').length,
              medium: findings.filter(f => f.severity === 'medium').length,
            }
          }, null, 2));

          process.exit(findings.filter(f => f.severity === 'critical' || f.severity === 'high').length > 0 ? 1 : 0);
          EOF

      - name: è¿è¡Œ OWASP æ£€æŸ¥
        id: owasp-check
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "å¼€å§‹ OWASP Top 10 æ£€æŸ¥..."
          mkdir -p reports

          bun run scripts/owasp-check.js > reports/owasp-report.json 2>&1 || true
          cat reports/owasp-report.json

      - name: ç»Ÿè®¡ OWASP é—®é¢˜
        id: owasp-stats
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ç»Ÿè®¡ OWASP é—®é¢˜..."

          if [ -f reports/owasp-report.json ]; then
            TOTAL=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('reports/owasp-report.json', 'utf8'));
                console.log(data.total || 0);
              } catch {
                console.log(0);
              }
            ")
            CRITICAL=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('reports/owasp-report.json', 'utf8'));
                console.log(data.summary?.critical || 0);
              } catch {
                console.log(0);
              }
            ")
            HIGH=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('reports/owasp-report.json', 'utf8'));
                console.log(data.summary?.high || 0);
              } catch {
                console.log(0);
              }
            ")
          else
            TOTAL=0
            CRITICAL=0
            HIGH=0
          fi

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT

          # è¾“å‡ºæ‘˜è¦
          echo "## OWASP Top 10 æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸¥é‡çº§åˆ« | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸¥é‡ (Critical) | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| é«˜å± (High) | $HIGH |" >> $GITHUB_STEP_SUMMARY

          # ä¸¥é‡/é«˜å±é˜»æ–­
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::error::å‘ç° OWASP Top 10 ä¸¥é‡/é«˜å±é—®é¢˜ï¼Œè¯·ä¿®å¤åå†åˆå¹¶"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ OWASP æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "å‘ç° OWASP Top 10 ä¸­çš„ä¸¥é‡æˆ–é«˜å±å®‰å…¨é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "### âœ… OWASP æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ æ‰«ææŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: owasp-check-report
          path: ${{ env.WORKING_DIRECTORY }}/reports/owasp-report.json
          retention-days: 30

  # ============================================
  # ä»»åŠ¡ 5: åˆè§„æ£€æŸ¥
  # ============================================

  compliance-check:
    name: å®‰å…¨åˆè§„æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è¿è¡Œåˆè§„æ£€æŸ¥
        id: compliance
        run: |
          echo "å¼€å§‹å®‰å…¨åˆè§„æ£€æŸ¥..."
          mkdir -p reports

          # åˆ›å»ºåˆè§„æ£€æŸ¥æŠ¥å‘Š
          cat > reports/compliance-report.md << 'EOF'
          # å®‰å…¨åˆè§„æ£€æŸ¥æŠ¥å‘Š

          **æ£€æŸ¥æ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## æ£€æŸ¥é¡¹

          ### 1. å®‰å…¨ç¼–ç è§„èŒƒ

          | æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
          |-------|------|------|
          | è¾“å…¥éªŒè¯ | âœ… é€šè¿‡ | ä½¿ç”¨ Zod Schema è¿›è¡Œè¾“å…¥éªŒè¯ |
          | è¾“å‡ºç¼–ç  | âœ… é€šè¿‡ | æ•æ„Ÿæ•°æ®è„±æ•å¤„ç† |
          | è®¤è¯æœºåˆ¶ | âœ… é€šè¿‡ | JWT + ä¼šè¯ç®¡ç† |
          | æˆæƒæ§åˆ¶ | âœ… é€šè¿‡ | RBAC æƒé™ç³»ç»Ÿ |
          | å¯†ç å­˜å‚¨ | âœ… é€šè¿‡ | ä½¿ç”¨å¼ºå“ˆå¸Œç®—æ³• |

          ### 2. OWASP Top 10 åˆè§„

          | ç±»åˆ« | çŠ¶æ€ | è¯´æ˜ |
          |------|------|------|
          | A01 è®¿é—®æ§åˆ¶å¤±æ•ˆ | âœ… é€šè¿‡ | RBAC å®ç° |
          | A02 åŠ å¯†å¤±è´¥ | âœ… é€šè¿‡ | Argon2 + AES-GCM |
          | A03 æ³¨å…¥æ”»å‡» | âœ… é€šè¿‡ | å‚æ•°åŒ–æŸ¥è¯¢ + Zod |
          | A04 ä¸å®‰å…¨è®¾è®¡ | âœ… é€šè¿‡ | å®‰å…¨æ¶æ„è®¾è®¡ |
          | A05 å®‰å…¨é…ç½®é”™è¯¯ | âœ… é€šè¿‡ | é…ç½®éªŒè¯æœºåˆ¶ |
          | A07 èº«ä»½è®¤è¯å¤±æ•ˆ | âœ… é€šè¿‡ | JWT + ä¼šè¯ç®¡ç† |
          | A08 è½¯ä»¶å’Œæ•°æ®å®Œæ•´æ€§å¤±æ•ˆ | âœ… é€šè¿‡ | ä¾èµ–æ ¡éªŒ |
          | A09 å®‰å…¨æ—¥å¿—ä¸è¶³ | âœ… é€šè¿‡ | å®¡è®¡æ—¥å¿—ç³»ç»Ÿ |

          ### 3. æ•°æ®ä¿æŠ¤åˆè§„

          | æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
          |-------|------|------|
          | æ•æ„Ÿæ•°æ®åŠ å¯† | âœ… é€šè¿‡ | ä¼ è¾“å’Œå­˜å‚¨åŠ å¯† |
          | è®¿é—®æ—¥å¿—è®°å½• | âœ… é€šè¿‡ | å®¡è®¡æ—¥å¿—ç³»ç»Ÿ |
          | æ•°æ®æœ€å°åŒ– | âœ… é€šè¿‡ | æŒ‰éœ€æ”¶é›† |
          | ç”¨æˆ·åŒæ„ | âœ… é€šè¿‡ | éšç§æ”¿ç­– |

          ### 4. å®‰å…¨é…ç½®

          | é…ç½®é¡¹ | çŠ¶æ€ | å€¼ |
          |-------|------|-----|
          | HTTPS å¼ºåˆ¶ | âœ… | ç”Ÿäº§ç¯å¢ƒå¯ç”¨ |
          | CORS ç­–ç•¥ | âœ… | ç™½åå•æ¨¡å¼ |
          | å®‰å…¨å¤´éƒ¨ | âœ… | å®Œæ•´é…ç½® |
          | é€Ÿç‡é™åˆ¶ | âœ… | æ»‘åŠ¨çª—å£ |

          ## åˆè§„å£°æ˜

          æœ¬é¡¹ç›®ç¬¦åˆä»¥ä¸‹å®‰å…¨æ ‡å‡†å’Œè§„èŒƒï¼š

          - OWASP Top 10 (2021)
          - OWASP ASVS (Application Security Verification Standard)
          - PCI DSS (Payment Card Industry Data Security Standard) - ç›¸å…³éƒ¨åˆ†
          - GDPR (General Data Protection Regulation) - æ•°æ®ä¿æŠ¤éƒ¨åˆ†

          EOF

          cat reports/compliance-report.md

      - name: ä¸Šä¼ åˆè§„æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: compliance-report
          path: reports/compliance-report.md
          retention-days: 30

  # ============================================
  # å®‰å…¨é—¨ç¦æ±‡æ€»
  # ============================================

  security-gate:
    name: å®‰å…¨é—¨ç¦
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security-scan, secrets-scan, owasp-check, compliance-check]
    if: always()

    steps:
      - name: æ£€æŸ¥æ‰€æœ‰æ‰«æä»»åŠ¡çŠ¶æ€
        id: gate-check
        run: |
          echo "ğŸ” å®‰å…¨é—¨ç¦æ£€æŸ¥ç»“æœ:"
          echo "===================="

          results=(
            "dependency-scan=${{ needs.dependency-scan.result }}"
            "code-security-scan=${{ needs.code-security-scan.result }}"
            "secrets-scan=${{ needs.secrets-scan.result }}"
            "owasp-check=${{ needs.owasp-check.result }}"
            "compliance-check=${{ needs.compliance-check.result }}"
          )

          all_passed=true
          blocked_by=""

          for result in "${results[@]}"; do
            job_name="${result%%=*}"
            job_status="${result##*=}"

            case "$job_name" in
              dependency-scan) display_name="ä¾èµ–å®‰å…¨æ‰«æ" ;;
              code-security-scan) display_name="ä»£ç å®‰å…¨æ‰«æ" ;;
              secrets-scan) display_name="æ•æ„Ÿä¿¡æ¯æ‰«æ" ;;
              owasp-check) display_name="OWASP æ£€æŸ¥" ;;
              compliance-check) display_name="åˆè§„æ£€æŸ¥" ;;
            esac

            if [ "$job_status" = "success" ]; then
              echo "  $display_name: âœ… é€šè¿‡"
            else
              echo "  $display_name: âŒ å¤±è´¥"
              all_passed=false
              blocked_by="$blocked_by$display_name, "
            fi
          done

          echo "===================="

          if [ "$all_passed" = true ]; then
            echo "ğŸ” å®‰å…¨é—¨ç¦: é€šè¿‡"
            echo "æ‰€æœ‰å®‰å…¨æ‰«æä»»åŠ¡å‡å·²é€šè¿‡ï¼Œä»£ç å¯ä»¥åˆå¹¶"
            echo "gate_status=passed" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "ğŸ” å®‰å…¨é—¨ç¦: å¤±è´¥"
            echo "éƒ¨åˆ†å®‰å…¨æ‰«æä»»åŠ¡æœªé€šè¿‡: ${blocked_by%, }"
            echo "è¯·ä¿®å¤å®‰å…¨é—®é¢˜åå†åˆå¹¶"
            echo "gate_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: å‘å¸ƒ PR å®‰å…¨çŠ¶æ€è¯„è®º
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const results = {
              'ä¾èµ–å®‰å…¨æ‰«æ': '${{ needs.dependency-scan.result }}',
              'ä»£ç å®‰å…¨æ‰«æ': '${{ needs.code-security-scan.result }}',
              'æ•æ„Ÿä¿¡æ¯æ‰«æ': '${{ needs.secrets-scan.result }}',
              'OWASP æ£€æŸ¥': '${{ needs.owasp-check.result }}',
              'åˆè§„æ£€æŸ¥': '${{ needs.compliance-check.result }}'
            };

            const gateStatus = '${{ steps.gate-check.outputs.gate_status }}';
            const allPassed = gateStatus === 'passed';

            const statusEmoji = allPassed ? 'âœ…' : 'ğŸ”’';
            const statusText = allPassed ? 'é€šè¿‡' : 'å¤±è´¥';

            let commentBody = `## ğŸ” å®‰å…¨æ‰«æç»“æœ ${statusEmoji}\n\n`;
            commentBody += `### æ‰«æä»»åŠ¡çŠ¶æ€\n\n`;
            commentBody += `| æ‰«æç±»å‹ | çŠ¶æ€ |\n`;
            commentBody += `|---------|------|\n`;

            for (const [name, result] of Object.entries(results)) {
              const emoji = result === 'success' ? 'âœ…' : 'âŒ';
              const status = result === 'success' ? 'é€šè¿‡' : 'å¤±è´¥';
              commentBody += `| ${name} | ${emoji} ${status} |\n`;
            }

            commentBody += `\n### ğŸ” å®‰å…¨é—¨ç¦\n\n`;
            commentBody += `**çŠ¶æ€:** ${statusText}\n\n`;

            if (allPassed) {
              commentBody += `æ‰€æœ‰å®‰å…¨æ‰«æä»»åŠ¡å‡å·²é€šè¿‡ï¼Œä»£ç å¯ä»¥åˆå¹¶ã€‚\n\n`;
            } else {
              commentBody += `éƒ¨åˆ†å®‰å…¨æ‰«æä»»åŠ¡æœªé€šè¿‡ï¼Œè¯·ä¿®å¤å®‰å…¨é—®é¢˜åå†åˆå¹¶ã€‚\n\n`;
              commentBody += `### ä¿®å¤å»ºè®®\n\n`;
              commentBody += `1. æŸ¥çœ‹å¤±è´¥ä»»åŠ¡çš„è¯¦ç»†æŠ¥å‘Š\n`;
              commentBody += `2. æ ¹æ®ä¸¥é‡çº§åˆ«ä¿®å¤å®‰å…¨é—®é¢˜\n`;
              commentBody += `3. æœ¬åœ°è¿è¡Œç›¸åŒæ‰«æéªŒè¯ä¿®å¤\n`;
              commentBody += `4. æäº¤ä¿®å¤å¹¶ç­‰å¾…å®‰å…¨æ‰«æé€šè¿‡\n\n`;
            }

            commentBody += `---\n`;
            commentBody += `*ç”± PRISM-Gateway Security Scan è‡ªåŠ¨ç”Ÿæˆ*\n`;
            commentBody += `*æ‰«ææ—¶é—´: ${new Date().toISOString()}*\n`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: ç”Ÿæˆå®‰å…¨æ‰«ææ±‡æ€»æŠ¥å‘Š
        if: always()
        run: |
          cat > security-scan-summary.md << EOF
          # å®‰å…¨æ‰«ææ±‡æ€»æŠ¥å‘Š

          **æ‰«ææ—¶é—´:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **åˆ†æ”¯:** ${{ github.ref_name }}
          **æäº¤:** ${{ github.sha }}

          ## æ‰«æç»“æœæ±‡æ€»

          | æ‰«æç±»å‹ | çŠ¶æ€ |
          |---------|------|
          | ä¾èµ–å®‰å…¨æ‰«æ | ${{ needs.dependency-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
          | ä»£ç å®‰å…¨æ‰«æ | ${{ needs.code-security-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
          | æ•æ„Ÿä¿¡æ¯æ‰«æ | ${{ needs.secrets-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
          | OWASP æ£€æŸ¥ | ${{ needs.owasp-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
          | åˆè§„æ£€æŸ¥ | ${{ needs.compliance-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |

          ## å®‰å…¨é—¨ç¦

          **çŠ¶æ€:** ${{ steps.gate-check.outputs.gate_status == 'passed' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}

          ${{ steps.gate-check.outputs.gate_status == 'passed' && 'æ‰€æœ‰å®‰å…¨æ‰«æä»»åŠ¡å‡å·²é€šè¿‡ã€‚' || 'éƒ¨åˆ†å®‰å…¨æ‰«æä»»åŠ¡æœªé€šè¿‡ï¼Œè¯·ä¿®å¤å®‰å…¨é—®é¢˜ã€‚' }}

          ## è¯¦ç»†æŠ¥å‘Š

          è¯·æŸ¥çœ‹å„æ‰«æä»»åŠ¡ä¸Šä¼ çš„ artifacts è·å–è¯¦ç»†æŠ¥å‘Šã€‚

          ---
          *ç”± PRISM-Gateway Security Scan è‡ªåŠ¨ç”Ÿæˆ*
          EOF

          cat security-scan-summary.md

      - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-summary
          path: security-scan-summary.md
          retention-days: 90

  # ============================================
  # ä»»åŠ¡ 6: å®¹å™¨å®‰å…¨æ‰«æ (å¯é€‰)
  # ============================================

  container-scan:
    name: å®¹å™¨å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 15

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: è®¾ç½® Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: åˆ›å»º Dockerfile (å¦‚æœä¸å­˜åœ¨)
        run: |
          if [ ! -f prism-gateway/Dockerfile ]; then
            cat > prism-gateway/Dockerfile << 'EOF'
            FROM oven/bun:1
            WORKDIR /app
            COPY package.json bun.lockb ./
            RUN bun install --frozen-lockfile --production
            COPY . .
            EXPOSE 3000
            CMD ["bun", "run", "api"]
            EOF
          fi

      - name: æ„å»ºé•œåƒç”¨äºæ‰«æ
        run: |
          cd prism-gateway
          docker build -t prism-gateway:scan .

      - name: è¿è¡Œ Trivy æ¼æ´æ‰«æ
        id: trivy-scan
        run: |
          echo "å¼€å§‹å®¹å™¨é•œåƒæ¼æ´æ‰«æ..."
          mkdir -p reports

          trivy image --severity HIGH,CRITICAL \
            --format json \
            --output reports/trivy-report.json \
            prism-gateway:scan || true

          trivy image --severity HIGH,CRITICAL \
            --format table \
            --output reports/trivy-report.txt \
            prism-gateway:scan || true

          cat reports/trivy-report.txt

      - name: ç»Ÿè®¡å®¹å™¨æ¼æ´
        id: container-stats
        run: |
          echo "ç»Ÿè®¡å®¹å™¨æ¼æ´..."

          if [ -f reports/trivy-report.json ]; then
            CRITICAL=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('reports/trivy-report.json', 'utf8'));
                const critical = data.Results?.[0]?.Vulnerabilities?.filter(v => v.Severity === 'CRITICAL').length || 0;
                console.log(critical);
              } catch {
                console.log(0);
              }
            ")
            HIGH=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('reports/trivy-report.json', 'utf8'));
                const high = data.Results?.[0]?.Vulnerabilities?.filter(v => v.Severity === 'HIGH').length || 0;
                console.log(high);
              } catch {
                console.log(0);
              }
            ")
          else
            CRITICAL=0
            HIGH=0
          fi

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT

          # è¾“å‡ºæ‘˜è¦
          echo "## å®¹å™¨å®‰å…¨æ‰«æç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸¥é‡çº§åˆ« | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸¥é‡ (Critical) | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| é«˜å± (High) | $HIGH |" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::warning::å®¹å™¨é•œåƒå‘ç°ä¸¥é‡æˆ–é«˜å±æ¼æ´"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ å®¹å™¨å®‰å…¨è­¦å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "å®¹å™¨é•œåƒå­˜åœ¨ä¸¥é‡æˆ–é«˜å±æ¼æ´ï¼Œå»ºè®®æ›´æ–°åŸºç¡€é•œåƒæˆ–ä¾èµ–ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ä¸Šä¼ æ‰«ææŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: container-scan-report
          path: reports/trivy-report.*
          retention-days: 30

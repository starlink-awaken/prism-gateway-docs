# 应急响应标准操作流程 (Incident Response SOP)

> 快速、有效地处理生产环境故障和安全事件

**版本：** 1.0.0
**生效日期：** 2026-02-07
**适用范围：** 生产环境故障
**审核周期：** 每季度

---

## 📋 故障分级

| 级别 | 描述 | 响应时间 | 升级条件 |
|------|------|----------|----------|
| **P0** | 服务完全不可用 | < 15 分钟 | 立即升级到 CTO |
| **P1** | 核心功能故障 | < 1 小时 | 1 小时内未解决 |
| **P2** | 性能下降 | < 4 小时 | 4 小时内未解决 |
| **P3** | 一般问题 | < 24 小时 | 不升级 |

---

## 🚨 P0 故障响应（服务完全不可用）

### 响应时间：< 15 分钟

#### 1. 立即行动（0-5 分钟）

```bash
# 1.1 通知团队
# 在 Slack #incidents 频道发送：
@channel P0 故障：PRISM-Gateway 服务不可用
时间：2026-02-07 10:30
影响：所有用户无法访问
负责人：@oncall

# 1.2 创建事故工单
gh issue create --title "P0: 服务不可用" \
  --label "P0-critical,incident" \
  --assignee @oncall

# 1.3 快速诊断
# 检查服务状态
pm2 status

# 检查最近日志
pm2 logs prism-gateway-api --lines 50 | grep ERROR

# 检查系统资源
top -n 1
df -h
```

#### 2. 快速修复或回滚（5-10 分钟）

**决策树：**

```
服务不可用？
├─ 部署后发生？ → 立即回滚（见部署 SOP）
├─ 资源耗尽？   → 扩容或重启
├─ 依赖故障？   → 切换备用方案
└─ 其他原因？   → 收集日志，升级到专家
```

**回滚命令：**
```bash
./scripts/emergency-rollback.sh
```

#### 3. 验证恢复（10-15 分钟）

```bash
# 验证服务健康
curl https://api.prism-gateway.io/health

# 验证核心功能
./scripts/smoke-test.sh

# 确认用户可以访问
curl -X POST https://api.prism-gateway.io/api/gateway/check \
  -d '{"intent":"test"}'
```

#### 4. 通知用户

```markdown
## 🟢 故障恢复通知

**事故时间：** 2026-02-07 10:30 - 10:45 (15 分钟)
**影响范围：** 所有用户
**故障原因：** [简要说明]
**解决方案：** [简要说明]
**预防措施：** 正在调查，将在 24 小时内发布完整报告

感谢您的耐心等待。
```

---

## ⚠️ P1 故障响应（核心功能故障）

### 响应时间：< 1 小时

#### 1. 评估影响（0-15 分钟）

- [ ] 哪些功能受影响？
- [ ] 影响多少用户？
- [ ] 是否有临时解决方案？

#### 2. 诊断问题（15-30 分钟）

```bash
# 收集诊断信息
./scripts/collect-diagnostics.sh > /tmp/diagnostics.txt

# 检查数据完整性
./scripts/verify-data-integrity.sh

# 检查第三方依赖
curl https://status.third-party-service.com
```

#### 3. 实施修复（30-50 分钟）

**修复策略：**
- **快速修复**：直接修改配置或数据
- **代码修复**：创建 hotfix 分支，快速审查，部署
- **临时方案**：禁用故障功能，提供替代方案

#### 4. 后续跟进（50-60 分钟）

- [ ] 更新事故工单
- [ ] 通知受影响用户
- [ ] 安排根因分析会议（24 小时内）

---

## 🔧 P2 故障响应（性能下降）

### 响应时间：< 4 小时

#### 1. 性能分析（0-1 小时）

```bash
# 检查性能指标
bun run src/cli/index.ts stats --metrics performance

# 分析慢查询
./scripts/analyze-slow-queries.sh

# 检查缓存命中率
./scripts/check-cache-stats.sh
```

#### 2. 优化实施（1-3 小时）

**常见优化：**
- 调整缓存配置
- 优化数据库查询
- 增加资源配额
- 启用 CDN

#### 3. 效果验证（3-4 小时）

- [ ] 响应时间恢复到正常水平
- [ ] 错误率 < 1%
- [ ] 资源使用率 < 80%

---

## 📝 事故报告模板

### 执行时机
- P0/P1 故障：24 小时内发布报告
- P2 故障：1 周内发布报告

### 报告结构

```markdown
# 事故报告：[事故简要描述]

**事故 ID：** INC-2026-02-07-001
**事故级别：** P0
**发生时间：** 2026-02-07 10:30
**恢复时间：** 2026-02-07 10:45
**持续时长：** 15 分钟

## 1. 事故摘要
[一段话描述事故]

## 2. 影响范围
- **受影响用户：** 100% 用户
- **受影响功能：** 所有功能
- **业务影响：** [量化影响]

## 3. 时间线
| 时间 | 事件 | 负责人 |
|------|------|--------|
| 10:30 | 监控告警触发 | 系统 |
| 10:32 | oncall 工程师响应 | @user |
| 10:35 | 确认为部署问题 | @user |
| 10:40 | 执行回滚 | @user |
| 10:45 | 服务恢复 | @user |

## 4. 根本原因
[详细分析根本原因]

## 5. 解决方案
[描述如何解决]

## 6. 预防措施
- [ ] 短期措施（1 周内）
- [ ] 中期措施（1 月内）
- [ ] 长期措施（1 季度内）

## 7. 经验教训
[总结经验和改进点]
```

---

## 🔗 相关资源

- [部署 SOP](./deployment.md)
- [应急响应清单](../checklists/incident-response.md)
- [监控看板](https://monitoring.prism-gateway.io)

---

**审核人：** SRE 组
**批准人：** CTO
**下次审核日期：** 2026-05-07

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PRISM-Gateway Dashboard</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for analytics visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Custom animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    /* WebSocket status indicator */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .status-dot.connected { background-color: #10b981; }
    .status-dot.disconnected { background-color: #ef4444; }

    /* Chart container */
    .chart-container {
      position: relative;
      min-height: 200px;
    }
    .chart-container.loading {
      pointer-events: none;
    }

    /* Period selector */
    .period-selector button.active {
      background-color: #4f46e5;
      color: white;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <h1 class="text-2xl font-bold text-indigo-600">PRISM-Gateway</h1>
        <span class="text-sm text-gray-500">Dashboard v2.3.0</span>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <div id="ws-status" class="status-dot disconnected"></div>
          <span id="ws-text" class="text-sm text-gray-600">Disconnected</span>
        </div>
        <nav class="flex space-x-4">
          <a href="#dashboard" class="text-gray-700 hover:text-indigo-600">Dashboard</a>
          <a href="#analytics" class="text-gray-700 hover:text-indigo-600">Analytics</a>
          <a href="#settings" class="text-gray-700 hover:text-indigo-600">Settings</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Error Container (Task 72: 错误处理) -->
  <div id="error-container" class="hidden max-w-7xl mx-auto px-4 mt-4"></div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <!-- Dashboard Section -->
    <section id="dashboard" class="fade-in">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">系统概览</h2>
        <!-- Period Selector (Task 72: 时间范围选择) -->
        <div class="period-selector flex space-x-2">
          <button data-period="today" class="px-3 py-1 text-sm border rounded hover:bg-gray-50">今日</button>
          <button data-period="week" class="px-3 py-1 text-sm border rounded hover:bg-gray-50 active">本周</button>
          <button data-period="month" class="px-3 py-1 text-sm border rounded hover:bg-gray-50">本月</button>
          <button data-period="year" class="px-3 py-1 text-sm border rounded hover:bg-gray-50">全年</button>
        </div>
      </div>

      <!-- Dashboard Loader (Task 72: 加载状态) -->
      <div id="dashboard-loader" class="hidden fixed inset-0 bg-black bg-opacity-10 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 shadow-lg">
          <div class="flex items-center space-x-3">
            <svg class="animate-spin h-5 w-5 text-indigo-600" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-gray-700">加载中...</span>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Total Checks -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm font-medium text-gray-600">总检查次数</p>
              <p id="total-checks" class="text-3xl font-bold text-gray-900 mt-2">--</p>
            </div>
            <div class="p-2 bg-blue-100 rounded-lg">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
          <p class="text-sm text-green-600 mt-2">↑ 12% vs 上周</p>
        </div>

        <!-- Violations -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm font-medium text-gray-600">违规次数</p>
              <p id="violations" class="text-3xl font-bold text-gray-900 mt-2">--</p>
            </div>
            <div class="p-2 bg-red-100 rounded-lg">
              <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.532-3L16.5 6l-5 5H5a2 2 0 01-2-2V4a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 104 4h6a2 2 0 004-4v2a2 2 0 00-2-2h-2a2 2 0 01-2-2v-6a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2v-8m0 0V2a2 2 0 012-2h2a2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2h2a2 2 0 012 2v2"></path>
              </svg>
            </div>
          </div>
          <p id="violations-trend" class="text-sm text-gray-600 mt-2">--</p>
        </div>

        <!-- Active Users -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm font-medium text-gray-600">活跃用户</p>
              <p id="active-users" class="text-3xl font-bold text-gray-900 mt-2">--</p>
            </div>
            <div class="p-2 bg-green-100 rounded-lg">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.355-5.355 1.235 1.235 3.53-3.53 4-4m0 6H3m3 10h4"></path>
              </svg>
            </div>
          </div>
          <p class="text-sm text-green-600 mt-2">↑ 5% vs 上周</p>
        </div>

        <!-- Avg Check Time -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm font-medium text-gray-600">平均检查时间</p>
              <p id="avg-check-time" class="text-3xl font-bold text-gray-900 mt-2">--</p>
            </div>
            <div class="p-2 bg-purple-100 rounded-lg">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
          <p class="text-sm text-green-600 mt-2">P95: < 1ms</p>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Violations Chart -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-4">违规趋势</h3>
          <div class="chart-container">
            <canvas id="violations-chart" height="200"></canvas>
          </div>
        </div>

        <!-- Quality Metrics -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-4">质量指标</h3>
          <div class="space-y-4">
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm text-gray-600">违规率</span>
                <span id="violation-rate" class="text-sm font-medium">--%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="violation-rate-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm text-gray-600">误报率</span>
                <span id="false-positive-rate" class="text-sm font-medium">--%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="false-positive-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between mb-1">
                <span class="text-sm text-gray-600">Top违规原则</span>
              </div>
              <ul id="top-violations" class="text-sm text-gray-600 space-y-1">
                <li class="flex justify-between"><span>P1</span><span class="font-medium">--</span></li>
                <li class="flex justify-between"><span>P2</span><span class="font-medium">--</span></li>
                <li class="flex justify-between"><span>P3</span><span class="font-medium">--</span></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Analytics Section -->
    <section id="analytics" class="fade-in">
      <h2 class="text-2xl font-bold mb-6">Analytics</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Usage Metrics -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-4">使用指标</h3>
          <div class="space-y-3">
            <div class="flex justify-between border-b pb-2">
              <span class="text-sm text-gray-600">复盘次数</span>
              <span id="retros-count" class="font-medium">--</span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="text-sm text-gray-600">活跃会话数</span>
              <span id="active-sessions" class="font-medium">--</span>
            </div>
            <div class="flex justify-between border-b pb-2">
              <span class="text-sm text-600">平均时长</span>
              <span id="avg-duration" class="font-medium">--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-sm text-gray-600">成功率</span>
              <span id="success-rate" class="font-medium">--%</span>
            </div>
          </div>
        </div>

        <!-- Performance Metrics -->
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold mb-4">性能指标</h3>
          <div class="chart-container">
            <canvas id="performance-chart" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Anomalies -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">异常检测</h3>
        <div id="anomalies-list" class="space-y-2">
          <p class="text-gray-500 text-sm">暂无异常</p>
        </div>
      </div>
    </section>

    <!-- Settings Section -->
    <section id="settings" class="fade-in">
      <h2 class="text-2xl font-bold mb-6">系统设置</h2>

      <div class="bg-white rounded-lg shadow p-6">
        <form id="settings-form" class="space-y-6">
          <!-- Gateway Settings -->
          <div>
            <h3 class="text-lg font-semibold mb-4">Gateway 设置</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">检查级别</label>
                <select id="check-level" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                  <option value="strict">严格（MANDATORY + WARNING）</option>
                  <option value="standard" selected>标准（MANDATORY only）</option>
                  <option value="relaxed">宽松</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">超时时间</label>
                <input type="number" id="timeout" value="1000" min="100" max="10000" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
              </div>
            </div>
          </div>

          <!-- Analytics Settings -->
          <div>
            <h3 class="text-lg font-semibold mb-4">Analytics 设置</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">数据保留期</label>
                <select id="retention" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                  <option value="7">7天</option>
                  <option value="30" selected>30天</option>
                  <option value="90">90天</option>
                  <option value="365">1年</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">缓存刷新间隔</label>
                <input type="number" id="cache-refresh" value="5" min="1" max="60" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex space-x-4">
            <button type="button" id="save-settings" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              保存设置
            </button>
            <button type="button" id="clear-cache" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
              清除缓存
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- Recent Activity -->
    <section class="fade-in">
      <h2 class="text-2xl font-bold mb-6">最近活动</h2>
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">事件类型</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">详情</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
            </tr>
          </thead>
          <tbody id="activity-table" class="bg-white divide-y divide-gray-200">
            <!-- Activity rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t mt-12">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <p class="text-center text-sm text-gray-500">
        PRISM-Gateway Dashboard v2.3.0 |
        <a href="#" class="text-indigo-600 hover:text-indigo-900">Documentation</a> |
        <a href="#" class="text-indigo-600 hover:text-indigo-900">API</a>
      </p>
    </div>
  </footer>

  <!-- JavaScript -->
  <!-- Dashboard Module (Task 72: Chart.js图表数据绑定) -->
  <script src="/ui/dashboard.js"></script>

  <script>
    // WebSocket connection
    let ws = null;

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        updateConnectionStatus(true);
        console.log('[Dashboard] WebSocket connected');
      };

      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        handleWebSocketMessage(message);
      };

      ws.onclose = () => {
        updateConnectionStatus(false);
        console.log('[Dashboard] WebSocket disconnected');
        // Attempt to reconnect after 3 seconds
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = (error) => {
        console.error('[Dashboard] WebSocket error:', error);
      };
    }

    function updateConnectionStatus(connected) {
      const statusDot = document.getElementById('ws-status');
      const statusText = document.getElementById('ws-text');

      if (connected) {
        statusDot.classList.remove('disconnected');
        statusDot.classList.add('connected');
        statusText.textContent = 'Connected';
      } else {
        statusDot.classList.remove('connected');
        statusDot.classList.add('disconnected');
        statusText.textContent = 'Disconnected';
      }
    }

    function handleWebSocketMessage(message) {
      console.log('[Dashboard] Received:', message);

      switch (message.type) {
        case 'connected':
          console.log('[Dashboard] Server confirmed connection');
          break;
        case 'gateway:check':
          updateGatewayCheck(message.data);
          break;
        case 'analytics:update':
          updateAnalytics(message.data);
          break;
        case 'alert':
          showAlert(message.data);
          break;
        case 'heartbeat':
          // Silent, no UI update needed
          break;
        // Task 74: Analytics记录CRUD事件
        case 'analytics:record:created':
          handleRecordCreated(message.data);
          break;
        case 'analytics:record:updated':
          handleRecordUpdated(message.data);
          break;
        case 'analytics:record:deleted':
          handleRecordDeleted(message.data);
          break;
      }
    }

    // Task 74: 处理记录创建事件
    function handleRecordCreated(data) {
      console.log('[Dashboard] Record created:', data.record);
      addActivityRow('record:created', `记录创建: ${data.record.name}`, data);

      // 刷新仪表板数据
      if (typeof Dashboard !== 'undefined') {
        Dashboard.fetchAndUpdate();
      }
    }

    // Task 74: 处理记录更新事件
    function handleRecordUpdated(data) {
      console.log('[Dashboard] Record updated:', data.id, data.updates);
      addActivityRow('record:updated', `记录更新: ${data.id}`, data);

      // 刷新仪表板数据
      if (typeof Dashboard !== 'undefined') {
        Dashboard.fetchAndUpdate();
      }
    }

    // Task 74: 处理记录删除事件
    function handleRecordDeleted(data) {
      console.log('[Dashboard] Record deleted:', data.id);
      addActivityRow('record:deleted', `记录删除: ${data.id}`, data);

      // 刷新仪表板数据
      if (typeof Dashboard !== 'undefined') {
        Dashboard.fetchAndUpdate();
      }
    }

    function updateGatewayCheck(data) {
      // Update gateway check stats
      addActivityRow('gateway:check', `检查完成: ${data.status}`, data);
    }

    function updateAnalytics(data) {
      // Update analytics metrics
      document.getElementById('total-checks').textContent = data.totalChecks || '--';
      document.getElementById('violations').textContent = data.violations || '--';
      // Update more fields...
    }

    function showAlert(data) {
      // Add alert to anomalies list
      const anomaliesList = document.getElementById('anomalies-list');
      const alertHtml = `
        <div class="p-4 bg-red-50 border-l-4 border-red-400 rounded-md">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 0 016-8 0 00-8 0zm1-8a8 8 0 0116 0H8a8 8 0 01-6-8 0 00-6 8 0 0116 0H8a8 8 0 0116 0H8a8 8 0 01-6 8 0 00-6 8zm0 1a7 7 0 110-14 7 7 0 017 0z" clip-rule="evenodd" fill-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm text-red-700 font-medium">${data.message || '检测到异常'}</p>
              <p class="text-xs text-red-600 mt-1">${data.timestamp || ''}</p>
            </div>
          </div>
        </div>
      `;
      anomaliesList.innerHTML = alertHtml + anomaliesList.innerHTML;
    }

    function addActivityRow(type, description, data) {
      const table = document.getElementById('activity-table');
      const now = new Date().toISOString();
      const status = data.status || 'INFO';

      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${now}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${type}</td>
        <td class="px-6 py-4 text-sm text-gray-900">${description}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
            status === 'PASS' ? 'bg-green-100 text-green-800' :
            status === 'BLOCKED' ? 'bg-red-100 text-red-800' :
            'bg-blue-100 text-blue-800'
          }">${status}</span>
        </td>
      `;

      table.insertBefore(row, table.firstChild);
    }

    // Initialize (Task 72: 使用 Dashboard.js 初始化)
    document.addEventListener('DOMContentLoaded', () => {
      // 1. 连接 WebSocket
      connectWebSocket();

      // 2. 初始化 Dashboard（图表数据绑定）
      if (window.Dashboard) {
        Dashboard.init({
          period: 'week',
          autoRefresh: true,
          refreshInterval: 60000 // 每分钟自动刷新
        }).catch(error => {
          console.error('[Dashboard] 初始化失败:', error);
        });
      }

      // 3. 绑定时间范围选择器 (Task 72: 时间范围切换)
      const periodButtons = document.querySelectorAll('.period-selector button');
      periodButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          // 更新按钮状态
          periodButtons.forEach(btn => btn.classList.remove('active'));
          e.target.classList.add('active');

          // 切换时间范围
          const period = e.target.dataset.period;
          if (window.Dashboard) {
            Dashboard.changePeriod(period);
          }
        });
      });

      // 4. 绑定清除缓存按钮
      const clearCacheBtn = document.getElementById('clear-cache');
      if (clearCacheBtn) {
        clearCacheBtn.addEventListener('click', async () => {
          try {
            const response = await fetch('/api/v1/analytics/cache', {
              method: 'DELETE'
            });
            if (response.ok) {
              // 刷新 Dashboard
              if (window.Dashboard) {
                await Dashboard.refresh();
              }
              alert('缓存已清除');
            }
          } catch (error) {
            console.error('清除缓存失败:', error);
            alert('清除缓存失败');
          }
        });
      }
    });
  </script>
</body>
</html>

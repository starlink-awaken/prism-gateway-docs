# PRISM-Gateway API 端到端集成测试

> **状态:** ✅ 完成 (2026-02-06)
> **测试数:** 50+
> **覆盖率:** 认证、验证、CORS、速率限制、安全性、性能

---

## 测试概述

本测试套件提供完整的端到端集成测试，验证 PRISM-Gateway REST API 的所有核心功能。

### 测试场景

| 场景 | 描述 | 测试数 |
|------|------|--------|
| **场景 1** | 用户认证全流程 | 13 |
| **场景 2** | API 完整流程 | 9 |
| **场景 3** | 输入验证流程 | 15 |
| **场景 4** | CORS 跨域保护 | 6 |
| **场景 5** | 速率限制功能 | 6 |
| **场景 6** | 完整用户旅程 | 3 |
| **场景 7** | 安全性测试 | 7 |
| **场景 8** | 并发请求处理 | 3 |

---

## 运行测试

### 运行所有 E2E 测试

```bash
bun test src/tests/api/e2e/api-e2e.test.ts
```

### 运行单个场景

```bash
# 只运行认证测试
bun test src/tests/api/e2e/api-e2e.test.ts --grep "场景 1"

# 只运行安全测试
bun test src/tests/api/e2e/api-e2e.test.ts --grep "场景 7"
```

### 查看性能报告

测试完成后会自动生成性能基准报告：

```
===========================================
       性能基准测试报告
===========================================

✅ PASS | 健康检查
      实际: 12.50ms (25.0%)
      目标: 50ms

✅ PASS | 登录请求
      实际: 45.20ms (22.6%)
      目标: 200ms

...

===========================================
总计: 8 测试, 7 通过, 1 失败
===========================================
```

---

## 测试覆盖

### 1. 用户认证全流程

- ✅ 成功登录并获取 Token
- ✅ 拒绝错误的用户名
- ✅ 拒绝错误的密码
- ✅ 拒绝缺少字段的请求
- ✅ 使用有效 Token 访问受保护端点
- ✅ 拒绝无 Token 的请求
- ✅ 拒绝无效的 Token
- ✅ 拒绝格式错误的 Authorization Header
- ✅ 成功刷新 Token
- ✅ 拒绝无效的刷新 Token
- ✅ 成功登出
- ✅ 拒绝无 Token 的登出请求
- ✅ GET /me 返回当前用户信息

### 2. API 完整流程

- ✅ 健康检查端点响应
- ✅ 根路径返回 API 信息
- ✅ 公开端点允许无认证访问
- ✅ 受保护端点要求认证
- ✅ 受保护端点接受有效 Token
- ✅ 受保护端点拒绝过期 Token
- ✅ 受保护端点拒绝篡改的 Token
- ✅ 返回标准错误响应格式
- ✅ 正确处理不存在的路由

### 3. 输入验证流程

- ✅ 接受有效的查询参数
- ✅ 接受默认查询参数
- ✅ 拒绝无效的 period 值
- ✅ 拒绝路径遍历攻击尝试
- ✅ 拒绝包含注入字符的参数
- ✅ 接受有效的请求体
- ✅ 拒绝缺少字段的请求体
- ✅ 拒绝过短的用户名
- ✅ 拒绝包含非法字符的用户名
- ✅ 拒绝过长的消息
- ✅ 拒绝无效的 JSON 格式
- ✅ 拒绝 SQL 注入尝试
- ✅ 拒绝 NoSQL 注入尝试
- ✅ 拒绝 XSS 攻击尝试
- ✅ 正确 trim 字符串输入

### 4. CORS 跨域保护

- ✅ 允许来自 localhost 的请求
- ✅ 允许来自 127.0.0.1 的请求
- ✅ 正确处理 CORS 预检请求
- ✅ 拒绝不允许的来源的预检请求
- ✅ 设置正确的 CORS 头
- ✅ 正确设置 Vary 头

### 5. 速率限制功能

- ✅ 正常使用下不触发速率限制
- ✅ 设置速率限制响应头
- ✅ 速率限制剩余数量递减
- ✅ 白名单 IP 不受速率限制
- ✅ 超过限制时正确限流
- ✅ 返回正确的错误格式

### 6. 完整用户旅程

- ✅ 新用户注册和使用流程（模拟）
- ✅ Token 过期后的自动刷新流程
- ✅ 错误恢复流程

### 7. 安全性测试

- ✅ 拒绝包含原型污染的请求
- ✅ 拒绝构造器污染尝试
- ✅ 正确处理大额请求体
- ✅ 拒绝空用户名
- ✅ 拒绝只有空格的用户名
- ✅ 拒绝 null 值
- ✅ 拒绝类型错误的字段

### 8. 并发请求处理

- ✅ 正确处理并发登录请求
- ✅ 正确处理并发受保护端点请求
- ✅ 并发请求中保持速率限制

---

## 性能基准

| 测试项 | 目标 | 当前状态 |
|--------|------|----------|
| 健康检查 | <50ms | ✅ |
| 登录请求 | <200ms | ✅ |
| 受保护 API | <100ms | ✅ |
| 输入验证 | <50ms | ✅ |
| 速率限制检查 | <50ms | ✅ |

---

## 已知限制

1. **IP 白名单测试** - 由于使用 `fetch` 进行测试，无法真正模拟客户端 IP 地址。白名单功能通过单元测试验证。

2. **Token 过期测试** - 使用负 TTL 模拟过期 Token，在真实场景中需要等待时间流逝。

3. **并发测试竞态** - 并发测试中的速率限制可能因执行顺序产生非确定性结果。

---

## 测试架构

```
api-e2e.test.ts
├── 测试常量
│   ├── API_BASE_URL
│   ├── TEST_PORT
│   ├── JWT_CONFIG
│   └── PERFORMANCE_TARGETS
├── 测试工具类
│   ├── TestMemoryStore (速率限制存储)
│   ├── MockUserService (模拟用户服务)
│   ├── TestHttpClient (HTTP 请求客户端)
│   └── 性能测量工具
├── 测试服务器
│   └── createTestServer()
└── 8 个测试场景
    ├── 场景 1: 用户认证全流程
    ├── 场景 2: API 完整流程
    ├── 场景 3: 输入验证流程
    ├── 场景 4: CORS 跨域保护
    ├── 场景 5: 速率限制功能
    ├── 场景 6: 完整用户旅程
    ├── 场景 7: 安全性测试
    └── 场景 8: 并发请求处理
```

---

## 维护指南

### 添加新测试

1. 确定测试所属场景
2. 使用 `TestHttpClient` 发送请求
3. 验证响应状态码和内容
4. 如需性能测试，添加到 `performanceMetrics`

### 修改性能目标

在 `PERFORMANCE_TARGETS` 常量中调整目标值：

```typescript
const PERFORMANCE_TARGETS = {
  healthCheck: 50,
  login: 200,
  protectedApi: 100,
  validation: 50,
  rateLimit: 50
};
```

### 调试失败的测试

```bash
# 运行测试并显示详细输出
bun test src/tests/api/e2e/api-e2e.test.ts --verbose

# 只运行失败的测试
bun test src/tests/api/e2e/api-e2e.test.ts --grep "测试名称"
```

---

## 相关文档

- [JWT 认证测试](../auth/JWTService.test.ts)
- [中间件测试](../middleware/)
- [验证 Schema 测试](../../validator/schemas.test.ts)
- [API 文档](../../../api/README.md)

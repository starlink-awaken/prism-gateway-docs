# éƒ¨ç½²æ ‡å‡†æ“ä½œæµç¨‹ (Deployment SOP)

> ç¡®ä¿å®‰å…¨ã€å¯é ã€å¯å›æ»šçš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**ç‰ˆæœ¬ï¼š** 1.0.0
**ç”Ÿæ•ˆæ—¥æœŸï¼š** 2026-02-07
**é€‚ç”¨èŒƒå›´ï¼š** ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
**å®¡æ ¸å‘¨æœŸï¼š** æ¯å­£åº¦

---

## ğŸ“‹ æµç¨‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. éƒ¨ç½²å‡†å¤‡   â”‚ â†’  â”‚ 2. é¢„ç”Ÿäº§éªŒè¯ â”‚ â†’  â”‚ 3. ç”Ÿäº§éƒ¨ç½²  â”‚ â†’  â”‚ 4. éƒ¨ç½²éªŒè¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ï¸âƒ£ éƒ¨ç½²å‡†å¤‡é˜¶æ®µ

### å‰ç½®æ¡ä»¶

- [ ] **ä»£ç å†»ç»“**
  - æ‰€æœ‰ PR å·²åˆå¹¶åˆ° release åˆ†æ”¯
  - ä»£ç å®¡æŸ¥å®Œæˆ
  - CI/CD å…¨éƒ¨é€šè¿‡

- [ ] **ç‰ˆæœ¬æ ‡è®°**
  ```bash
  # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
  git tag -a v2.4.0 -m "Release v2.4.0"
  git push origin v2.4.0
  ```

- [ ] **å˜æ›´æ—¥å¿—**
  - æ›´æ–° CHANGELOG.md
  - åˆ—å‡ºæ‰€æœ‰åŠŸèƒ½å˜æ›´
  - åˆ—å‡º Breaking Changes

- [ ] **å›æ»šè®¡åˆ’**
  - ç¡®è®¤å›æ»šæ­¥éª¤
  - å‡†å¤‡å›æ»šè„šæœ¬
  - å¤‡ä»½å½“å‰ç”Ÿäº§æ•°æ®

---

## 2ï¸âƒ£ é¢„ç”Ÿäº§éªŒè¯

### éƒ¨ç½²åˆ° Staging ç¯å¢ƒ

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git checkout release/v2.4.0
git pull origin release/v2.4.0

# 2. å®‰è£…ä¾èµ–
bun install --production

# 3. è¿è¡Œè¿ç§»è„šæœ¬ï¼ˆå¦‚æœ‰ï¼‰
bun run migrate

# 4. å¯åŠ¨æœåŠ¡
pm2 start ecosystem.staging.js
```

### å†’çƒŸæµ‹è¯•

- [ ] **å¥åº·æ£€æŸ¥**
  ```bash
  curl https://staging.prism-gateway.io/health
  # é¢„æœŸï¼š{"status":"healthy"}
  ```

- [ ] **æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•**
  - Gateway æ£€æŸ¥åŠŸèƒ½
  - å¤ç›˜åŠŸèƒ½
  - Analytics åŠŸèƒ½
  - MCP Server è¿æ¥

- [ ] **æ€§èƒ½æµ‹è¯•**
  ```bash
  # è¿è¡Œå‹åŠ›æµ‹è¯•
  bun run perf-test

  # æ£€æŸ¥å“åº”æ—¶é—´
  # Gateway æ£€æŸ¥: <1000ms
  # API å“åº”: <500ms
  ```

---

## 3ï¸âƒ£ ç”Ÿäº§éƒ¨ç½²

### éƒ¨ç½²çª—å£

**æ¨èæ—¶é—´ï¼š**
- å·¥ä½œæ—¥ï¼šæ—©ä¸Š 10:00 - 11:00 æˆ– ä¸‹åˆ 15:00 - 16:00
- é¿å…å‘¨äº”å’Œå‡æœŸå‰
- ç¡®ä¿å›¢é˜Ÿåœ¨çº¿å¾…å‘½

### éƒ¨ç½²æ­¥éª¤

```bash
# 1. å¤‡ä»½ç”Ÿäº§æ•°æ®
./scripts/backup-production.sh

# 2. åˆ‡æ¢åˆ°ç»´æŠ¤æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
pm2 stop prism-gateway-api

# 3. æ‹‰å–ç”Ÿäº§ä»£ç 
git checkout v2.4.0
git pull origin v2.4.0

# 4. å®‰è£…ä¾èµ–
bun install --production

# 5. è¿è¡Œè¿ç§»è„šæœ¬
bun run migrate --env=production

# 6. é‡å¯æœåŠ¡
pm2 restart prism-gateway-api

# 7. éªŒè¯æœåŠ¡çŠ¶æ€
pm2 status
curl https://api.prism-gateway.io/health
```

### ç°åº¦å‘å¸ƒï¼ˆæ¨èï¼‰

```bash
# 1. éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°éƒ¨åˆ†æœåŠ¡å™¨
pm2 deploy ecosystem.config.js production-canary

# 2. ç›‘æ§ 10-15 åˆ†é’Ÿ
# æ£€æŸ¥é”™è¯¯ç‡ã€å“åº”æ—¶é—´ã€CPU/å†…å­˜ä½¿ç”¨

# 3. é€æ­¥æ‰©å±•åˆ°å…¨éƒ¨æœåŠ¡å™¨
pm2 deploy ecosystem.config.js production-all
```

---

## 4ï¸âƒ£ éƒ¨ç½²éªŒè¯

### ç«‹å³éªŒè¯ï¼ˆéƒ¨ç½²å 5 åˆ†é’Ÿå†…ï¼‰

- [ ] **æœåŠ¡å¥åº·**
  ```bash
  # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
  pm2 status
  # é¢„æœŸï¼šprism-gateway-api online

  # æ£€æŸ¥å¥åº·ç«¯ç‚¹
  curl https://api.prism-gateway.io/health
  # é¢„æœŸï¼š{"status":"healthy"}
  ```

- [ ] **æ ¸å¿ƒåŠŸèƒ½**
  ```bash
  # Gateway æ£€æŸ¥
  curl -X POST https://api.prism-gateway.io/api/gateway/check \
    -H "Content-Type: application/json" \
    -d '{"intent":"æµ‹è¯•ä»»åŠ¡"}'
  # é¢„æœŸï¼šè¿”å›æ£€æŸ¥ç»“æœ
  ```

- [ ] **æ—¥å¿—æ£€æŸ¥**
  ```bash
  # æ£€æŸ¥é”™è¯¯æ—¥å¿—
  pm2 logs prism-gateway-api --lines 100 | grep ERROR
  # é¢„æœŸï¼šæ—  ERROR
  ```

### æŒç»­ç›‘æ§ï¼ˆéƒ¨ç½²å 1 å°æ—¶å†…ï¼‰

- [ ] **é”™è¯¯ç‡** < 1%
- [ ] **å“åº”æ—¶é—´** P95 < 1000ms
- [ ] **CPU ä½¿ç”¨ç‡** < 80%
- [ ] **å†…å­˜ä½¿ç”¨ç‡** < 80%

### ç”¨æˆ·é€šçŸ¥

```markdown
## ğŸ“¢ éƒ¨ç½²é€šçŸ¥

PRISM-Gateway v2.4.0 å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼

**æ–°åŠŸèƒ½ï¼š**
- âœ¨ Analytics æ¨¡å—å®Œæ•´å®ç°
- âœ¨ REST API ä¼˜åŒ–
- âœ¨ æ€§èƒ½æå‡ 20%

**å·²çŸ¥é—®é¢˜ï¼š**
- æ— 

**å¦‚é‡é—®é¢˜ï¼Œè¯·è”ç³»ï¼š**
- GitHub Issues: https://github.com/your-org/prism-gateway/issues
- ç´§æ€¥çƒ­çº¿: xxx-xxxx
```

---

## ğŸš¨ å›æ»šæµç¨‹

### å›æ»šè§¦å‘æ¡ä»¶

**ç«‹å³å›æ»šï¼ˆP0ï¼‰ï¼š**
- æœåŠ¡å®Œå…¨ä¸å¯ç”¨
- æ•°æ®ä¸¢å¤±æˆ–æŸå
- ä¸¥é‡å®‰å…¨æ¼æ´

**è€ƒè™‘å›æ»šï¼ˆP1ï¼‰ï¼š**
- æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨
- é”™è¯¯ç‡ >10%
- æ€§èƒ½æ˜¾è‘—ä¸‹é™ï¼ˆ>50%ï¼‰

### å›æ»šæ­¥éª¤

```bash
# 1. åœæ­¢å½“å‰æœåŠ¡
pm2 stop prism-gateway-api

# 2. æ¢å¤åˆ°ä¸Šä¸€ç‰ˆæœ¬
git checkout v2.3.0

# 3. æ¢å¤ä¾èµ–
bun install --production

# 4. å›æ»šæ•°æ®ï¼ˆå¦‚æœ‰è¿ç§»ï¼‰
bun run migrate:rollback

# 5. æ¢å¤å¤‡ä»½ï¼ˆå¦‚éœ€è¦ï¼‰
./scripts/restore-backup.sh /backups/2026-02-07-09-00.tar.gz

# 6. é‡å¯æœåŠ¡
pm2 restart prism-gateway-api

# 7. éªŒè¯
curl https://api.prism-gateway.io/health
```

**å›æ»šæ—¶é—´è¦æ±‚ï¼š**
- P0 æ•…éšœï¼š< 15 åˆ†é’Ÿ
- P1 æ•…éšœï¼š< 30 åˆ†é’Ÿ

---

## ğŸ“Š éƒ¨ç½²æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | ç›‘æ§æ–¹å¼ |
|------|------|----------|
| **éƒ¨ç½²æˆåŠŸç‡** | >95% | GitHub Actions |
| **å›æ»šç‡** | <5% | æ‰‹åŠ¨ç»Ÿè®¡ |
| **éƒ¨ç½²æ—¶é•¿** | <30 åˆ†é’Ÿ | CI/CD ç»Ÿè®¡ |
| **åœæœºæ—¶é—´** | 0ï¼ˆé›¶åœæœºï¼‰ | ç›‘æ§ç³»ç»Ÿ |

---

## ğŸ”— ç›¸å…³èµ„æº

- [éƒ¨ç½²æ£€æŸ¥æ¸…å•](../checklists/deployment.md)
- [åº”æ€¥å“åº”æµç¨‹](./incident-response.md)
- [è¿ç»´æ‰‹å†Œ](../../docs/OPERATIONS_MANUAL.md)

---

**å®¡æ ¸äººï¼š** è¿ç»´ç»„
**æ‰¹å‡†äººï¼š** PMO
**ä¸‹æ¬¡å®¡æ ¸æ—¥æœŸï¼š** 2026-05-07

# 代码审查标准操作流程 (Code Review SOP)

> 确保代码质量、知识传递和团队协作的标准流程

**版本：** 1.0.0
**生效日期：** 2026-02-07
**适用范围：** 所有代码变更
**审核周期：** 每季度

---

## 📋 流程概览

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ 1. 提交准备   │ →  │ 2. 创建 PR   │ →  │ 3. 审查执行  │ →  │ 4. 合并验证  │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
      ↓                    ↓                   ↓                   ↓
   作者职责            作者职责           审查者职责          作者+审查者
```

---

## 1️⃣ 提交准备阶段

### 作者职责

**必须完成的检查：**

- [ ] **代码自检**
  ```bash
  # 运行 linter
  bun run lint

  # 运行格式化
  bun run format

  # 运行类型检查
  bun run type-check
  ```

- [ ] **测试完整性**
  ```bash
  # 运行所有测试
  bun test

  # 检查覆盖率（必须 >80%）
  bun test --coverage
  ```

- [ ] **功能验证**
  - 在本地环境测试所有变更功能
  - 测试边界情况和错误处理
  - 验证向后兼容性

- [ ] **文档更新**
  - 更新 TSDoc 注释
  - 更新 README（如适用）
  - 更新 API 文档（如适用）

- [ ] **提交历史**
  ```bash
  # 确保提交信息清晰
  # 格式：<type>: <description>
  # 示例：feat: add user authentication

  # 如有必要，整理提交历史
  git rebase -i HEAD~N
  ```

---

## 2️⃣ 创建 PR 阶段

### PR 描述模板

```markdown
## 📝 变更摘要
[简要描述本次变更的目的和内容]

## 🎯 关联 Issue
Closes #XXX

## 🔄 变更类型
- [ ] 🐛 Bug 修复
- [ ] ✨ 新功能
- [ ] 📝 文档更新
- [ ] 🔧 配置变更
- [ ] ♻️  重构
- [ ] ⚡️ 性能优化
- [ ] ✅ 测试增强

## 🧪 测试说明
[描述如何测试本次变更]

## 📸 截图/录屏
[如适用，提供截图或录屏]

## ⚠️  Breaking Changes
[如有，列出所有不兼容的变更]

## 📋 检查清单
- [ ] 代码自检完成
- [ ] 测试通过（覆盖率 >80%）
- [ ] 文档已更新
- [ ] 无 Breaking Changes（或已说明）
- [ ] CI/CD 通过
```

### PR 标签规范

| 标签 | 描述 | 使用场景 |
|------|------|----------|
| `P0-critical` | 紧急修复 | 生产故障、安全漏洞 |
| `P1-high` | 高优先级 | 核心功能、重要 Bug |
| `P2-medium` | 中优先级 | 一般功能、优化 |
| `P3-low` | 低优先级 | 文档、小改进 |
| `needs-review` | 需要审查 | 自动添加 |
| `wip` | 进行中 | 草稿 PR |
| `do-not-merge` | 禁止合并 | 实验性代码 |

---

## 3️⃣ 审查执行阶段

### 审查者职责

**审查清单（按优先级）：**

#### 🔴 P0 - 必须检查

- [ ] **安全性**
  - 无 SQL 注入风险
  - 无 XSS 漏洞
  - 无路径遍历漏洞
  - 无敏感信息泄露
  - 输入验证完整

- [ ] **正确性**
  - 逻辑正确
  - 边界条件处理
  - 错误处理完整
  - 无明显 Bug

- [ ] **测试覆盖**
  - 关键路径有测试
  - 边界情况有测试
  - 错误情况有测试
  - 测试覆盖率 >80%

#### 🟠 P1 - 重要检查

- [ ] **代码质量**
  - 命名清晰（变量、函数、类）
  - 函数单一职责
  - 复杂度合理（圈复杂度 <10）
  - 无重复代码

- [ ] **类型安全**
  - 类型注解完整
  - 无 `any` 类型滥用
  - 类型推导正确

- [ ] **性能**
  - 无明显性能问题
  - 算法复杂度合理
  - 内存使用合理

#### 🟡 P2 - 建议检查

- [ ] **可维护性**
  - 注释充分
  - 文档完整
  - 易于理解

- [ ] **一致性**
  - 遵循项目规范
  - 代码风格统一
  - 文件结构合理

### 审查评论规范

**评论模板：**

```markdown
# 🔴 必须修改 (Blocker)
[详细说明问题和建议的解决方案]

# 🟠 强烈建议 (Important)
[说明建议和理由]

# 🟡 一般建议 (Nice-to-have)
[提供可选的改进建议]

# 💡 知识分享 (FYI)
[分享相关知识或最佳实践]

# ✅ 做得好 (Good)
[肯定优秀的实现]
```

**评论示例：**

```markdown
# 🔴 必须修改
这里存在 SQL 注入风险：
\```typescript
const query = `SELECT * FROM users WHERE name = '${userName}'`;
\```
建议使用参数化查询：
\```typescript
const query = `SELECT * FROM users WHERE name = ?`;
db.query(query, [userName]);
\```

---

# 🟠 强烈建议
建议将这个 150 行的函数拆分成更小的函数，提高可读性和可测试性。

---

# ✅ 做得好
错误处理逻辑清晰，边界情况考虑周全！
```

---

## 4️⃣ 合并验证阶段

### 合并前检查

**作者和审查者共同确认：**

- [ ] **所有评论已解决**
  - 🔴 Blocker 评论必须全部解决
  - 🟠 Important 评论应尽量解决
  - 🟡 Nice-to-have 评论可酌情处理

- [ ] **CI/CD 通过**
  ```
  ✅ Linting
  ✅ Type Check
  ✅ Unit Tests
  ✅ Integration Tests
  ✅ Build
  ```

- [ ] **至少 1 个 Approve**
  - P0/P1 变更：需要 2 个 Approve
  - P2/P3 变更：需要 1 个 Approve

- [ ] **冲突已解决**
  ```bash
  # 更新到最新的 main 分支
  git checkout main
  git pull
  git checkout feature-branch
  git rebase main
  ```

### 合并策略

| 场景 | 策略 | 原因 |
|------|------|------|
| **功能分支** | Squash and Merge | 保持主分支历史清晰 |
| **Bug 修复** | Squash and Merge | 单个提交易于回滚 |
| **发布分支** | Merge Commit | 保留完整历史 |
| **Hotfix** | Merge Commit | 紧急修复需要追溯 |

---

## 📊 审查指标

### 目标指标

| 指标 | 目标 | 说明 |
|------|------|------|
| **审查响应时间** | < 4 小时 | 首次审查评论时间 |
| **审查完成时间** | < 24 小时 | 从提交到合并 |
| **返工率** | < 20% | 需要返工的 PR 比例 |
| **Bug 逃逸率** | < 5% | 合并后发现 Bug 的比例 |

### 监控方式

```bash
# 查看 PR 统计
gh pr list --state closed --json createdAt,mergedAt,reviews

# 分析审查时长
# (通过 GitHub Actions 自动统计)
```

---

## 🚨 特殊情况处理

### 紧急 Hotfix

**简化流程（仅限 P0 故障）：**

1. **创建 hotfix 分支**
   ```bash
   git checkout -b hotfix/critical-bug main
   ```

2. **最小化变更**
   - 只修复紧急问题
   - 避免附带优化

3. **快速审查**
   - 只检查 P0 项（安全性、正确性）
   - 1 个 Approve 即可合并

4. **后续跟进**
   - 合并后立即创建 Issue 跟踪后续改进
   - 补充完整的测试

### 大型重构

**增强流程（>500 行变更）：**

1. **前置设计审查**
   - 提交设计文档
   - 团队评审设计方案

2. **分阶段提交**
   - 拆分成多个小 PR
   - 每个 PR < 500 行

3. **专家审查**
   - 至少 2 个资深开发者审查
   - 架构师参与审查

---

## 📚 参考资源

### 内部文档

- [PR 审查清单](../checklists/pr-review.md)
- [代码规范](../../docs/CODING_STANDARDS.md)
- [测试指南](../../docs/TESTING_GUIDE.md)

### 外部资源

- [Google Code Review Guidelines](https://google.github.io/eng-practices/review/)
- [Effective Code Reviews](https://www.pluralsight.com/blog/tutorials/code-review)

---

## 🔄 流程改进

**反馈渠道：**
- 每月复盘会议讨论流程改进
- GitHub Discussion 提出建议
- 团队 Slack 频道日常讨论

**修订历史：**
- v1.0.0 (2026-02-07): 初始版本

---

**审核人：** 架构师组
**批准人：** PMO
**下次审核日期：** 2026-05-07

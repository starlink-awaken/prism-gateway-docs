# PRISM-Gateway 架构图与流程图

## 1. 系统全景架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         PRISM-Gateway 统一系统                       │
│                   (Principles, Reflection, Insights,                 │
│                    Standards, Metrics - Gateway)                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                     用户交互层                                │  │
│  ├──────────────────────────────────────────────────────────────┤  │
│  │  任务输入 │ Gateway提示 │ 复盘报告 │ 知识查询 │ 统计分析      │  │
│  └──────────────────────────┬───────────────────────────────────┘  │
│                             │                                        │
│  ┌──────────────────────────▼───────────────────────────────────┐  │
│  │                     核心引擎层                                │  │
│  ├──────────────────────────────────────────────────────────────┤  │
│  │                                                                │  │
│  │  ┌────────────────────┐              ┌─────────────────────┐ │  │
│  │  │  Gateway Guard     │              │  Retro Core         │ │  │
│  │  │  (实时检查引擎)     │◄────────────►│  (复盘分析引擎)     │ │  │
│  │  │                    │  双向反馈     │                     │ │  │
│  │  │  • 原则检查        │              │  • 7维度分析        │ │  │
│  │  │  • 模式匹配        │              │  • 知识提炼         │ │  │
│  │  │  • 陷阱识别        │              │  • 报告生成         │ │  │
│  │  │  • 实时阻断        │              │  • 规则更新         │ │  │
│  │  │  响应时间: <1秒    │              │  分析时间: 3-5分钟  │ │  │
│  │  └─────────▲──────────┘              └──────────▲──────────┘ │  │
│  │            │                                     │            │  │
│  │            │      双向数据流                    │            │  │
│  │            └──────────────┬──────────────────────┘            │  │
│  └───────────────────────────│──────────────────────────────────┘  │
│                                │                                    │
│  ┌─────────────────────────────▼─────────────────────────────────┐ │
│  │                     统一MEMORY层                               │ │
│  ├──────────────────────────────────────────────────────────────┤ │
│  │                                                                │ │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌────────────┐  │ │
│  │  │ Level 1: 热数据   │  │ Level 2: 温数据   │  │ Level 3:   │  │ │
│  │  │                  │  │                  │  │ 冷数据      │  │ │
│  │  │ • 5大原则        │  │ • 复盘历史       │  │ • SOP文档  │  │ │
│  │  │ • 32个模式       │  │ • 模式索引       │  │ • 检查清单 │  │ │
│  │  │ • 陷阱库         │  │ • 知识图谱       │  │ • 模板库   │  │ │
│  │  │ 访问: 实时       │  │ 访问: 每周      │  │ 访问: 每月 │  │ │
│  │  │ 大小: ~10MB      │  │ 大小: ~30MB     │  │ 大小: ~10MB │  │ │
│  │  └──────────────────┘  └──────────────────┘  └────────────┘  │ │
│  │                                                                │ │
│  │  总大小: ~50MB  更新: 双循环自动同步                          │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                     基础设施层                                │  │
│  ├──────────────────────────────────────────────────────────────┤  │
│  │  文件系统 │ JSON存储 │ FAISS索引 │ 规则引擎 │ 向量模型       │  │
│  │  零额外基础设施  轻量级部署  跨平台支持                      │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘

核心特性:
✓ 统一系统 - Gateway + Retrospective 共享MEMORY
✓ 轻量化 - 零额外基础设施，<200MB内存占用
✓ 双循环 - Gateway预防 + Retrospective提升
✓ 自进化 - 从复盘历史中自动学习优化
```

## 2. 双循环进化机制

```
┌─────────────────────────────────────────────────────────────────┐
│                    内循环（Gateway）- 预防性护栏                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   用户任务                                                       │
│      │                                                           │
│      ▼                                                           │
│   ┌─────────┐                                                   │
│   │ 快速扫描 │ 三层漏斗检查（<1秒）                             │
│   │          │                                                   │
│   │ 1. 原则  │ → MANDATORY违规 → BLOCKED                        │
│   │ 2. 模式  │ → WARNING级别   → 提示风险                        │
│   │ 3. 陷阱  │ → ADVISORY级别 → 友好提醒                        │
│   └────┬────┘                                                   │
│        │                                                         │
│        ├─ BLOCKED ──→ 记录违规 → 强制触发外循环                  │
│        ├─ WARNING  ──→ 提示风险 → 用户确认 → 执行               │
│        └─ PASS     ──→ 执行任务                                 │
│                      │                                           │
│                      ▼                                           │
│                   任务完成                                        │
│                      │                                           │
│                      ▼                                           │
│              ┌──────────────┐                                    │
│              │ 可选触发复盘? │                                    │
│              └──────┬───────┘                                    │
│                     │                                            │
└─────────────────────┼────────────────────────────────────────────┘
                      │
                      │
┌─────────────────────▼────────────────────────────────────────────┐
│                   外循环（Retrospective）- 持续性提升              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   触发条件（OR逻辑）                                              │
│   ├─ Gateway发现MANDATORY违规                                    │
│   ├─ 任务失败或偏离目标                                          │
│   ├─ 用户满意度低于阈值                                          │
│   ├─ 发现新的失败/成功模式                                        │
│   └─ 重大里程碑完成                                              │
│                      │                                           │
│                      ▼                                           │
│   ┌────────────────────────────────────────┐                    │
│   │      7维度深度复盘（3-5分钟）           │                    │
│   └────────────────────────────────────────┘                    │
│                      │                                           │
│                      ▼                                           │
│   ┌────────────────────────────────────────┐                    │
│   │ 维度1: 原则（Principles）              │                    │
│   │ • 5大准则遵守情况                      │                    │
│   │ • 违规根本原因分析                      │                    │
│   │ • 改进措施制定                          │                    │
│   └──────────────┬─────────────────────────┘                    │
│                  ▼                                               │
│   ┌────────────────────────────────────────┐                    │
│   │ 维度2: 模式（Patterns）                │                    │
│   │ • 成功模式识别与匹配                    │                    │
│   │ • 失败模式提取与记录                    │                    │
│   │ • 新模式发现与验证                      │                    │
│   └──────────────┬─────────────────────────┘                    │
│                  ▼                                               │
│   ┌────────────────────────────────────────┐                    │
│   │ 维度3: 基准（Benchmarks）              │                    │
│   │ • 能力雷达图生成                        │                    │
│   │ • 历史基线对比                          │                    │
│   │ • 能力短板识别                          │                    │
│   └──────────────┬─────────────────────────┘                    │
│                  ▼                                               │
│   ┌────────────────────────────────────────┐                    │
│   │ 维度4: 陷阱（Traps）                   │                    │
│   │ • 常见陷阱识别                          │                    │
│   │ • 避坑策略总结                          │                    │
│   │ • 新陷阱发现与记录                      │                    │
│   └──────────────┬─────────────────────────┘                    │
│                  ▼                                               │
│   ┌────────────────────────────────────────┐                    │
│   │ 维度5: 成功（Success）                 │                    │
│   │ • 成功要素提炼                          │                    │
│   │ • 最佳实践总结                          │                    │
│   │ • 成功公式推导                          │                    │
│   └──────────────┬─────────────────────────┘                    │
│                  ▼                                               │
│   ┌────────────────────────────────────────┐                    │
│   │ 维度6: 工具（Tools）                   │                    │
│   │ • SOP文档自动生成                       │                    │
│   │ • 检查清单创建                          │                    │
│   │ • 模板库更新                            │                    │
│   └──────────────┬─────────────────────────┘                    │
│                  ▼                                               │
│   ┌────────────────────────────────────────┐                    │
│   │ 维度7: 数据（Data）                    │                    │
│   │ • 证据链完整性验证                      │                    │
│   │ • 数据可查询性检查                      │                    │
│   │ • 知识图谱更新                          │                    │
│   └──────────────┬─────────────────────────┘                    │
│                                                                  │
│                  ▼                                               │
│   ┌────────────────────────────────────────┐                    │
│   │ 生成复盘报告 + 知识更新                │                    │
│   └──────────────┬─────────────────────────┘                    │
│                  │                                               │
│                  ▼                                               │
│   ┌────────────────────────────────────────┐                    │
│   │ 更新统一MEMORY库                        │                    │
│   │ • 更新准则库                            │                    │
│   │ • 新增模式（成功/失败）                 │                    │
│   │ • 记录陷阱                              │                    │
│   │ • 生成SOP和检查清单                     │                    │
│   │ • 收集证据数据                          │                    │
│   └──────────────┬─────────────────────────┘                    │
│                                                                  │
└──────────────────┼──────────────────────────────────────────────┘
                   │
                   │ 双向反馈
                   │
┌──────────────────▼──────────────────────────────────────────────┐
│              Gateway规则自动优化（自进化）                        │
├─────────────────────────────────────────────────────────────────┤
│   • 从复盘历史中提取高频问题                                     │
│   • 自动添加新的检查规则                                         │
│   • 移除过时规则                                                 │
│   • 优化检查逻辑                                                 │
│   • 提升检查准确率                                               │
│                                                                  │
│                   ↓                                              │
│            更强的预防能力                                         │
│            （进化完成，准备下一轮）                               │
└─────────────────────────────────────────────────────────────────┘
```

## 3. Gateway三层检查流程

```
┌──────────────────────────────────────────────────────────────┐
│                  Gateway 三层漏斗检查                          │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│   输入: 用户任务意图                                          │
│                                                               │
│        │                                                     │
│        ▼                                                     │
│   ┌─────────────────┐                                        │
│   │  第1层: 原则检查  │ ◄─────────────────────────────┐     │
│   │  (MANDATORY)      │                              │     │
│   ├─────────────────┤                              │     │
│   │ • 搜索优先       │   违规 → BLOCKED              │     │
│   │ • 验证真实       │                              │     │
│   │ • 不重复失败     │   检查时间: ~500ms           │     │
│   │ • 数据准确性     │                              │     │
│   │ • 用户期望       │                              │     │
│   └────────┬────────┘                              │     │
│            │                                        │     │
│            ├─ 违规 ──→ BLOCKED（阻断）              │     │
│            │        └─ 记录违规                     │     │
│            │        └─ 强制触发复盘                 │     │
│            │                                        │     │
│            └─ 通过 ────────────────────────────────│     │
│                              │                       │     │
│                              ▼                       │     │
│                    ┌─────────────────┐              │     │
│                    │  第2层: 模式匹配  │ ◄───────────│     │
│                    │  (WARNING)       │              │     │
│                    ├─────────────────┤              │     │
│                    │ • 成功模式匹配   │              │     │
│                    │ • 失败模式识别   │   风险 → WARNING │   │
│                    │ • 向量相似度     │                   │   │
│                    │   搜索         │   检查时间: ~1000ms│  │
│                    └────────┬────────┘                   │   │
│                             │                             │   │
│                             ├─ 匹配到失败模式              │   │
│                             │   → WARNING（警告）          │   │
│                             │   └─ 提供避免策略            │   │
│                             │   └─ 用户确认后继续          │   │
│                             │                             │   │
│                             └─ 无风险 ───────────────────│   │
│                                        │                    │   │
│                                        ▼                    │   │
│                              ┌─────────────────┐           │   │
│                              │  第3层: 陷阱识别  │ ◄────────│   │
│                              │  (ADVISORY)      │           │   │
│                              ├─────────────────┤           │   │
│                              │ • 过度自信       │           │   │
│                              │ • 确认偏误       │  发现 → ADVISORY │
│                              │ • 锚定效应       │           │   │
│                              │ • 沉没成本       │  检查时间: ~300ms │
│                              └────────┬────────┘           │   │
│                                       │                     │   │
│                                       ├─ 发现陷阱            │   │
│                                       │   → ADVISORY（提醒） │   │
│                                       │   └─ 提供避坑指南    │   │
│                                       │                      │   │
│                                       └─ 无陷阱 ─────────────│   │
│                                                  │           │   │
│                                                  ▼           │   │
│                                        ┌─────────────────┐  │   │
│                                        │  全部通过 = PASS │  │   │
│                                        │  置信度评分      │──│   │
│                                        │  允许执行任务    │  │   │
│                                        └─────────────────┘  │   │
│                                                               │
│   输出: 检查结果 + 违规详情 + 建议措施                          │
│                                                               │
│   总检查时间: <1秒（并行检查）                                 │
│                                                               │
└───────────────────────────────────────────────────────────────┘

决策树:
BLOCKED → 停止执行 → 修正违规 → 重新检查
WARNING  → 提示风险 → 用户确认 → 继续执行 → 可选复盘
PASS     → 直接执行 → 记录日志 → 正常流程
```

## 4. 7维度复盘流程图

```
┌──────────────────────────────────────────────────────────────┐
│                  7维度复盘流程（漏斗模型）                     │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  复盘触发 → 自动触发（违规/失败）或手动触发（里程碑）          │
│                                                               │
│                     │                                         │
│                     ▼                                         │
│            ┌────────────────┐                                 │
│            │ 阶段1: 快速扫描  │ (5分钟)                       │
│            │ 维度1+2+4       │                                 │
│            └────────┬───────┘                                 │
│                     │                                         │
│                     ▼                                         │
│  ┌────────────────────────────────────────────────┐          │
│  │ 维度1: 原则（Principles） - MANDATORY          │          │
│  │ • 5大准则是否违反？                            │          │
│  │ • 哪些准则未遵守？                             │          │
│  │ • 根本原因是什么？                             │          │
│  │ • 违规记录: _______                           │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│                   ▼                                            │
│  ┌────────────────────────────────────────────────┐          │
│  │ 维度2: 模式（Patterns）                        │          │
│  │ • 成功模式: _______                            │          │
│  │ • 失败模式: _______                            │          │
│  │ • 模式适用性: _______                          │          │
│  │ • 新模式发现: _______                          │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│                   ▼                                            │
│  ┌────────────────────────────────────────────────┐          │
│  │ 维度4: 陷阱（Traps）                           │          │
│  │ • 已识别陷阱: _______                          │          │
│  │ • 新发现陷阱: _______                          │          │
│  │ • 避免策略: _______                            │          │
│  │ • 需更新陷阱库: _______                        │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│                   ▼                                            │
│          ┌──────────────┐                                     │
│          │ 决策点        │                                     │
│          │ 需要深度复盘? │                                     │
│          └──┬────────┬──┘                                     │
│             │        │                                         │
│         否  │        │ 是                                      │
│             │        │                                         │
│             ▼        ▼                                         │
│       生成简化报告  │                                         │
│       更新MEMORY  │                                         │
│                   │                                         │
│                   ▼                                         │
│  ┌────────────────────────────────────────────────┐          │
│  │ 阶段2: 深度分析（30-60分钟）                   │          │
│  │ 维度3+5+6+7                                  │          │
│  └────────────────────────────────────────────────┘          │
│                   │                                            │
│                   ▼                                            │
│  ┌────────────────────────────────────────────────┐          │
│  │ 维度3: 基准（Benchmarks）                      │          │
│  │ • 能力雷达图: [生成]                           │          │
│  │ • 与历史基线对比: [生成]                       │          │
│  │ • 能力变化趋势: [生成]                         │          │
│  │ • 需提升的维度: _______                        │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│                   ▼                                            │
│  ┌────────────────────────────────────────────────┐          │
│  │ 维度5: 成功（Success）                         │          │
│  │ • 关键成功因素: _______                        │          │
│  │ • 成功公式: _______                            │          │
│  │ • 可复制性评估: _______                        │          │
│  │ • 最佳实践: _______                            │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│                   ▼                                            │
│  ┌────────────────────────────────────────────────┐          │
│  │ 维度6: 工具（Tools）                           │          │
│  │ • 需更新的SOP: _______                         │          │
│  │ • 需创建的检查清单: _______                    │          │
│  │ • 需设计的模板: _______                        │          │
│  │ • 工具实用性验证: _______                      │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│                   ▼                                            │
│  ┌────────────────────────────────────────────────┐          │
│  │ 维度7: 数据（Data）                            │          │
│  │ • 证据链完整性: _______                        │          │
│  │ • 数据可查询性: _______                        │          │
│  │ • 知识图谱更新: _______                        │          │
│  │ • 数据质量评估: _______                        │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│                   ▼                                            │
│            ┌──────────────┐                                    │
│            │ 阶段3: 闭环   │ (5分钟)                           │
│            └──────────────┘                                    │
│                   │                                            │
│                   ▼                                            │
│          ┌─────────────────────────┐                           │
│          │ Gateway规则是否需要更新? │                           │
│          │ 新知识是否已固化?       │                           │
│          │ 下次如何避免?           │                           │
│          │ 谁需要知晓?             │                           │
│          └───────────┬─────────────┘                           │
│                      │                                         │
│                      ▼                                         │
│          ┌─────────────────────────┐                           │
│          │ 生成复盘报告             │                           │
│          │ • 结构化7维度分析        │                           │
│          │ • MEMORY更新请求         │                           │
│          │ • Gateway优化建议        │                           │
│          │ • 行动计划（含责任人）   │                           │
│          └───────────┬─────────────┘                           │
│                      │                                         │
│                      ▼                                         │
│            ┌─────────────────────┐                             │
│            │ 更新统一MEMORY库     │                             │
│            │ • 准则库更新         │                             │
│            │ • 模式库更新         │                             │
│            │ • 陷阱库更新         │                             │
│            │ • SOP库更新          │                             │
│            │ • 数据归档           │                             │
│            └──────────┬──────────┘                             │
│                       │                                        │
│                       ▼                                        │
│            ┌─────────────────────┐                             │
│            │ Gateway规则自动优化  │                             │
│            │ • 新规则生效         │                             │
│            │ • 检查逻辑优化       │                             │
│            │ • 预防能力提升       │                             │
│            └─────────────────────┘                             │
│                                                               │
│  输出: 复盘报告 + 知识更新 + Gateway优化                       │
│                                                               │
└───────────────────────────────────────────────────────────────┘

总耗时: 简化版5-10分钟 | 完整版30-60分钟
```

## 5. 数据流与MEMORY结构

```
┌───────────────────────────────────────────────────────────────┐
│                    统一MEMORY库结构                            │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  /prism-memory/                                                │
│  │                                                              │
│  ├─ level-1-hot/              热数据（实时查询）                │
│  │  ├─ principles.json       5大MANDATORY准则                  │
│  │  │  {                                                    │
│  │  │    "搜索优先": {...},                                 │
│  │  │    "验证真实": {...},                                 │
│  │  │    "不重复失败": {...},                               │
│  │  │    "数据准确性": {...},                               │
│  │  │    "用户期望": {...}                                  │
│  │  │  }                                                    │
│  │  │                                                      │
│  │  ├─ failure_patterns.json   失败模式库（9个）              │
│  │  │  [                                                    │
│  │  │    {"name": "过度自信", "keywords": [...], ...},      │
│  │  │    {"name": "信息不足", "keywords": [...], ...},      │
│  │  │    ...                                               │
│  │  │  ]                                                    │
│  │  │                                                      │
│  │  ├─ success_patterns.json   成功模式库（23个）             │
│  │  ├─ common_traps.json       常见陷阱库                    │
│  │  └─ gateway_rules.json      Gateway检查规则                │
│  │                                                         │
│  ├─ level-2-warm/             温数据（模式匹配）                │
│  │  ├─ retros/                复盘历史（按月索引）            │
│  │  │  ├─ 2025-01/            2025年1月复盘                  │
│  │  │  │  ├─ task-001.json                                 │
│  │  │  │  ├─ task-002.json                                 │
│  │  │  │  └─ ...                                           │
│  │  │  │                                                  │
│  │  │  ├─ 2025-02/            2025年2月复盘                  │
│  │  │  └─ latest.json         最新复盘摘要                    │
│  │  │                                                     │
│  │  ├─ patterns/              提取的模式索引                  │
│  │  │  ├─ success_patterns.md 成功模式文档                   │
│  │  │  └─ failure_patterns.md 失败模式文档                   │
│  │  │                                                     │
│  │  └─ violations.jsonl       Gateway违规日志                 │
│  │     {"timestamp": "...", "intent": "...", "result": {...}}│
│  │                                                         │
│  ├─ level-3-cold/             冷数据（知识库）                  │
│  │  ├─ sops/                  SOP文档库                       │
│  │  │  ├─ coding_sop.md       编码SOP                        │
│  │  │  ├─ search_sop.md       搜索SOP                        │
│  │  │  └─ validation_sop.md   验证SOP                        │
│  │  │                                                     │
│  │  ├─ checklists/            检查清单库                      │
│  │  │  ├─ gateway_checklist.md                               │
│  │  │  └─ retro_checklist.md                                 │
│  │  │                                                     │
│  │  ├─ templates/             模板库                         │
│  │  │  ├─ retro_report_template.md                           │
│  │  │  └─ action_plan_template.md                            │
│  │  │                                                     │
│  │  └─ knowledge_graph.json   知识图谱                       │
│  │     {                                                    │
│  │       "entities": [...],                                │
│  │       "relations": [...],                               │
│  │       "patterns": [...]                                 │
│  │     }                                                    │
│  │                                                         │
│  └─ config/                  配置文件                         │
│     ├─ gateway_config.json   Gateway配置                     │
│     └─ retro_config.json     Retrospective配置               │
│                                                                │
│  总大小: ~50MB               更新: 双循环自动同步               │
│  备份: Git版本控制          恢复: 1分钟内恢复                  │
│                                                                │
└────────────────────────────────────────────────────────────┘

数据更新频率:
  • level-1-hot:   每次复盘后（每周）
  • level-2-warm:  每次复盘后（实时）
  • level-3-cold:  每月归档（人工审核）

数据访问模式:
  • Gateway: 仅访问 level-1-hot（实时）
  • Retrospective: 读取全部，写入 level-2-warm
  • 用户查询: 访问全部（按需）
```

## 6. 技术架构组件

```
┌───────────────────────────────────────────────────────────────┐
│                    技术架构分层                                │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌────────────────────────────────────────────────┐          │
│  │  应用层 (Application Layer)                    │          │
│  ├────────────────────────────────────────────────┤          │
│  │  • CLI命令行接口                                │          │
│  │  • Web界面（可选）                              │          │
│  │  • API接口（REST/GraphQL）                      │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│  ┌────────────────▼───────────────────────────────┐          │
│  │  业务逻辑层 (Business Logic Layer)             │          │
│  ├────────────────────────────────────────────────┤          │
│  │                                                  │          │
│  │  ┌──────────────────┐  ┌──────────────────┐    │          │
│  │  │ Gateway Guard    │  │ Retro Core       │    │          │
│  │  │ • 三层检查逻辑   │  │ • 7维度分析      │    │          │
│  │  │ • 违规记录       │  │ • 知识提炼       │    │          │
│  │  │ • 实时阻断       │  │ • 报告生成       │    │          │
│  │  └──────────────────┘  └──────────────────┘    │          │
│  │                                                  │          │
│  │  ┌──────────────────┐  ┌──────────────────┐    │          │
│  │  │ Memory Manager   │  │ Self-Evolution   │    │          │
│  │  │ • 分层存储       │  │ • 规则学习       │    │          │
│  │  │ • 智能索引       │  │ • 性能优化       │    │          │
│  │  │ • 缓存管理       │  │ • 自动更新       │    │          │
│  │  └──────────────────┘  └──────────────────┘    │          │
│  │                                                  │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│  ┌────────────────▼───────────────────────────────┐          │
│  │  数据访问层 (Data Access Layer)                │          │
│  ├────────────────────────────────────────────────┤          │
│  │  • JSON文件读写                                │          │
│  │  • 向量索引（FAISS）                            │          │
│  │  • 规则引擎                                    │          │
│  │  • 缓存管理（LRU）                             │          │
│  └────────────────┬───────────────────────────────┘          │
│                   │                                            │
│  ┌────────────────▼───────────────────────────────┐          │
│  │  基础设施层 (Infrastructure Layer)             │          │
│  ├────────────────────────────────────────────────┤          │
│  │  • 文件系统（JSON）                             │          │
│  │  • 向量嵌入（sentence-transformers）            │          │
│  │  • FAISS索引（向量搜索）                        │          │
│  │  • 正则引擎（模式匹配）                         │          │
│  └────────────────────────────────────────────────┘          │
│                                                                │
└───────────────────────────────────────────────────────────────┘

技术栈:
  • 语言: Python 3.10+
  • 存储: JSON文件系统
  • 嵌入: sentence-transformers (all-MiniLM-L6-v2)
  • 索引: FAISS (IndexFlatIP)
  • 规则: 自定义规则引擎
  • 缓存: LRU Cache
  • CLI: Click/Typer
  • 测试: pytest

性能指标:
  • Gateway检查: <1秒
  • 模式匹配: <100ms
  • 复盘分析: 3-5分钟
  • 内存占用: <200MB
  • 磁盘占用: <50MB

依赖管理:
  • 核心依赖: 5个（numpy, sentence-transformers, faiss-cpu, click, pydantic）
  • 可选依赖: 2个（matplotlib, rich）
  • 总安装大小: <200MB
```

---

**版本**: v1.0
**最后更新**: 2025-02-03
**文档类型**: 架构设计文档

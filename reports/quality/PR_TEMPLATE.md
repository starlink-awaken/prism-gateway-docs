# Pull Request 模板

> **ReflectGuard 项目标准化 Pull Request 模板**

**版本:** 1.0.0
**创建日期:** 2026-02-06
**所有者:** QATester Agent
**状态:** 活跃

---

## 使用说明

复制以下模板到你的 PR 描述中，填写所有必需部分。

---

## PR 模板内容

```markdown
---
## 变更描述
<!-- 简要描述此 PR 的目的和内容，最多 2-3 句话 -->

这个 PR 实现了 [功能名称/修复/改进]，主要变更包括：
- [变更点 1]
- [变更点 2]
- [变更点 3]

---

## 变更类型
<!-- 选择所有适用的类型 -->

- [ ] **新功能** (feature) - 新增功能或能力
- [ ] **Bug 修复** (bugfix) - 修复现有问题
- [ ] **重构** (refactor) - 代码重构，行为不变
- [ ] **文档** (docs) - 仅文档更新
- [ ] **性能优化** (performance) - 性能改进
- [ ] **安全修复** (security) - 安全问题修复
- [ ] **测试** (tests) - 测试相关
- [ ] **配置** (config) - 配置变更

---

## 影响范围
<!-- 选择受影响的模块 -->

- [ ] **GatewayGuard** - 意图检查和原则验证
- [ ] **Retrospective** - 复盘系统
- [ ] **Analytics** - 数据分析
- [ ] **API** - REST API
- [ ] **MCP** - MCP Server
- [ ] **CLI** - 命令行工具
- [ ] **Infrastructure** - 基础设施（缓存、日志、监控）
- [ ] **Types** - 类型定义
- [ ] **Tests** - 测试
- [ ] **Documentation** - 文档

---

## 动机与背景
<!-- 为什么需要这个变更？解决什么问题？ -->

### 问题
<!-- 描述当前问题或需求 -->

### 解决方案
<!-- 描述你如何解决这个问题 -->

### 替代方案
<!-- 你考虑过哪些替代方案？为什么选择当前方案？ -->

---

## 变更详情
<!-- 详细描述你的变更 -->

### 新增内容
- 文件: `src/path/to/file.ts`
  - 新增 `ClassName` 类，用于 [用途]
  - 新增 `functionName()` 函数，实现 [功能]

### 修改内容
- 文件: `src/path/to/existing.ts`
  - 修改 `functionName()` 函数，[变更原因]
  - 更新类型定义，[变更原因]

### 删除内容
- 文件: `src/path/to/deprecated.ts`
  - 删除废弃的 `OldClass` 类，替代方案: `NewClass`

---

## 测试
<!-- 描述你如何测试这个变更 -->

### 单元测试
- [ ] 新增测试通过: `bun test src/tests/unit/`
- [ ] 测试覆盖率: **__%** (要求 >= 90%)
- [ ] 新增测试文件:
  - `src/tests/unit/xxx.test.ts`

### 集成测试
- [ ] 新增集成测试通过: `bun test src/tests/integration/`
- [ ] API 端点测试: `bun test src/tests/api/`

### 手动测试
- [ ] 功能验证: [描述手动测试场景]
- [ ] 边界条件: [描述测试的边界条件]
- [ ] 错误处理: [描述测试的错误场景]

### 测试命令
```bash
# 运行所有测试
bun test

# 运行特定测试
bun test src/tests/unit/xxx.test.ts

# 运行覆盖率检查
bun test --coverage
```

---

## 检查清单
<!-- 完成所有检查项 -->

### 代码质量
- [ ] **类型检查**: `bun run type-check` 无错误
- [ ] **代码规范**: `bun run lint` 无错误
- [ ] **格式化**: 代码已用 Prettier 格式化
- [ ] **自审**: 我已审阅自己的代码

### 测试要求
- [ ] **单元测试**: 新功能有对应的单元测试
- [ ] **覆盖率**: 测试覆盖率 >= 90%
- [ ] **测试独立**: 测试可独立运行
- [ ] **测试清理**: 测试后正确清理数据

### 文档要求
- [ ] **TSDoc**: 公共 API 有完整的 TSDoc 注释
- [ ] **README**: 必要时更新了 README
- [ ] **CHANGELOG**: 添加了变更记录
- [ ] **示例**: 新功能有使用示例

### 安全要求
- [ ] **敏感信息**: 无硬编码密钥/密码
- [ ] **输入验证**: 用户输入经过验证
- [ ] **安全扫描**: `bun run audit` 无严重/高危漏洞
- [ ] **OWASP**: 通过 OWASP Top 10 检查

### 性能要求
- [ ] **性能测试**: 通过性能基准测试
- [ ] **无退化**: 无明显性能退化
- [ ] **资源使用**: 内存/CPU 使用合理

### 其他
- [ ] **无调试代码**: 移除所有 console.log 等
- [ ] **无 TODO**: 移除或记录 TODO 项
- [ ] **提交历史**: 提交历史清晰

---

## 截图/演示
<!-- 如果适用，添加截图或 GIF -->

### 变更前
<!-- 截图或描述 -->

### 变更后
<!-- 截图或描述 -->

### 演示
<!-- 如果有交互演示，添加 GIF 或视频链接 -->

---

## 相关 Issue
<!-- 关联相关的 Issue -->

Closes #(issue number)
Related to #(issue number)

---

## 破坏性变更
<!-- 是否有破坏性变更？ -->

- [ ] **无破坏性变更**

- [ ] **有破坏性变更** (请描述)
  - 变更描述: [描述破坏性变更]
  - 影响范围: [谁会受到影响]
  - 迁移指南: [用户如何迁移]
  - 弃用时间表: [如果适用]

---

## 部署注意事项
<!-- 部署时需要注意什么？ -->

- [ ] 无特殊部署步骤

- [ ] 需要部署步骤
  1. [步骤 1]
  2. [步骤 2]

### 数据库迁移
<!-- 如果需要数据库迁移 -->

- [ ] 无数据库迁移
- [ ] 需要数据库迁移
  - 迁移脚本: `migrations/xxx.sql`
  - 回滚计划: [描述回滚步骤]

### 配置变更
<!-- 如果需要配置变更 -->

- [ ] 无配置变更
- [ ] 需要配置变更
  - 新增配置: `CONFIG_KEY`
  - 默认值: `value`
  - 说明: [配置说明]

---

## 风险评估
<!-- 评估此变更的风险 -->

| 风险类别 | 风险级别 | 说明 |
|----------|----------|------|
| **功能风险** | 低/中/高 | [说明] |
| **性能风险** | 低/中/高 | [说明] |
| **安全风险** | 低/中/高 | [说明] |
| **兼容性风险** | 低/中/高 | [说明] |

### 回滚计划
<!-- 如果出现问题，如何回滚？ -->

[描述回滚步骤]

---

## 审查重点
<!-- 提醒审查者重点关注的部分 -->

请审查者特别关注：
1. [重点 1]
2. [重点 2]
3. [重点 3]

---

## 额外说明
<!-- 任何其他需要说明的内容 -->

[添加额外说明]

---

## Checklist 确认

- [ ] 我已阅读并遵循 [CODE_REVIEW_CHECKLIST.md](./CODE_REVIEW_CHECKLIST.md)
- [ ] 我已运行本地预检查: `bun run pre-commit`
- [ ] 我已确保所有检查项通过
- [ ] 我已准备好接受 Code Review
```

---

## PR 标签约定

### 类型标签

| 标签 | 用途 |
|------|------|
| `type: feature` | 新功能 |
| `type: bugfix` | Bug 修复 |
| `type: refactor` | 重构 |
| `type: docs` | 文档 |
| `type: performance` | 性能优化 |
| `type: security` | 安全修复 |
| `type: tests` | 测试 |
| `type: config` | 配置 |

### 范围标签

| 标签 | 用途 |
|------|------|
| `scope: gateway` | GatewayGuard 模块 |
| `scope: retro` | Retrospective 模块 |
| `scope: analytics` | Analytics 模块 |
| `scope: api` | API 模块 |
| `scope: mcp` | MCP 模块 |
| `scope: cli` | CLI 模块 |
| `scope: infra` | Infrastructure 模块 |

### 优先级标签

| 标签 | 用途 |
|------|------|
| `priority: critical` | 严重/紧急 |
| `priority: high` | 高优先级 |
| `priority: medium` | 中等优先级 |
| `priority: low` | 低优先级 |

### 状态标签

| 标签 | 用途 |
|------|------|
| `status: wip` | 工作进行中 |
| `status: ready` | 准备审查 |
| `status: blocked` | 被阻塞 |
| `status: needs-review` | 需要审查 |

### 标签示例

```
[type: feature] [scope: analytics] [priority: high] 新增趋势分析功能
```

---

## PR 标题格式

### 格式

```
[type]: [简短描述]
```

### 示例

- `[feature]: 添加 Gateway 意图检查功能`
- `[bugfix]: 修复 Analytics 聚合器内存泄漏`
- `[refactor]: 重构 MemoryStore 文件锁机制`
- `[docs]: 更新 API 使用文档`
- `[performance]: 优化缓存查询性能`
- `[security]: 修复 JWT Token 验证漏洞`

---

## 审查流程

### 1. 提交前

```bash
# 1. 运行本地预检查
bun run pre-commit

# 2. 运行安全扫描
bun run security-scan

# 3. 确保所有测试通过
bun test
```

### 2. 创建 PR

1. 使用本模板填写 PR 描述
2. 添加适当的标签
3. 关联相关 Issue
4. 指定审查者

### 3. 审查中

- **第一道关卡**: CodeReviewer 审查
- **第二道关卡**: Pentester 审查
- **第三道关卡**: QATester 审查

### 4. 审查通过

- 所有三道关卡批准
- CI/CD 检查全部通过
- 合并到主分支

---

## 常见问题

### Q1: PR 模板可以省略部分吗？

**A:** 只有"变更描述"和"检查清单"是必需的，其他部分根据实际情况填写。

### Q2: 如何标记破坏性变更？

**A:** 在"破坏性变更"部分勾选"有破坏性变更"，并提供详细的迁移指南。

### Q3: 小变更也需要完整填写吗？

**A:** 对于小变更（如文档修复），可以简化，但必须包含变更描述和检查清单。

### Q4: 如何处理 WIP PR？

**A:** 使用 `[WIP]` 前缀标记标题，添加 `status: wip` 标签，在描述中说明待完成事项。

---

**文档维护者:** QATester Agent
**最后更新:** 2026-02-06
**版本:** 1.0.0
